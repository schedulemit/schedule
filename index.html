<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">

    <title>–†–æ–∑–∫–ª–∞–¥ –ö–∞—Ñ–µ–¥—Ä–∏ –ú–Ü–¢</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root { 
            --univ-blue: #0f172a; 
            --bg-color: #f1f5f9; 
            --card-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            --swap-mode-bg: #ecfdf5; --swap-mode-border: #4ade80;
            --move-mode-bg: #eff6ff; --move-mode-border: #60a5fa;
            --slot-bg: #f8fafc; --slot-hatch: #f1f5f9;
            --live-text: #854d0e; --live-color: #eab308; --live-bg: #fefce8; --live-border: #facc15;
            
            --diff-added: #dcfce7; --diff-added-border: #22c55e;
            --diff-removed: #fee2e2; --diff-removed-border: #ef4444;
            --diff-changed: #ffedd5; --diff-changed-border: #f97316;
            
            /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ –∑–º—ñ–Ω–Ω—ñ */
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --card-bg: white;
            --day-column-bg: #e2e8f0;
        }
        
        /* üåô –ì–∞—Ä–Ω–∞ —Ç–µ–º–Ω–∞ —Ç–µ–º–∞ –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º–∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞–º–∏ */
        body.dark-mode {
            --univ-blue: #93c5fd;
            --bg-color: #0a0e1a;
            --card-shadow: 0 4px 6px -1px rgba(0,0,0,0.4);
            --swap-mode-bg: #064e3b; --swap-mode-border: #34d399;
            --move-mode-bg: #1e3a8a; --move-mode-border: #60a5fa;
            --slot-bg: #1a1f2e; --slot-hatch: #232938;
            --live-text: #fcd34d; --live-color: #fbbf24; --live-bg: #451a03; --live-border: #f59e0b;
            
            --diff-added: #065f46; --diff-added-border: #34d399;
            --diff-removed: #991b1b; --diff-removed-border: #f87171;
            --diff-changed: #92400e; --diff-changed-border: #fb923c;
            
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --card-bg: #1e293b;
            --day-column-bg: #1a222e;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); margin: 0; padding: 1rem; color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; }
        
        /* üéØ –°—Ç–∏–ª—ñ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ –∑–º—ñ–Ω */
        .btn-sync.has-changes {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4) !important;
            animation: pulse-changes 2s infinite;
        }
        
        .btn-sync.no-changes {
            opacity: 0.5;
            cursor: default;
        }
        
        .btn-sync.no-changes:hover {
            transform: none !important;
            opacity: 0.5 !important;
        }
        
        @keyframes pulse-changes {
            0%, 100% { box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
            50% { box-shadow: 0 4px 20px rgba(59, 130, 246, 0.6); }
        }
        
        body.dark-mode .btn-sync.has-changes {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%) !important;
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.5) !important;
        }
        
        /* üé® –°—Ç–∏–ª—å–Ω–∏–π tooltip –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑—ñ –∑–º—ñ–Ω–∞–º–∏ */
        .btn-sync.has-changes::after {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
            padding: 10px 16px !important;
            font-size: 0.875rem !important;
            font-weight: 600 !important;
            border-radius: 10px !important;
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.4), 0 0 0 2px rgba(59, 130, 246, 0.2) !important;
            letter-spacing: 0.3px;
        }
        
        .btn-sync.has-changes::before {
            border-color: #2563eb transparent transparent transparent !important;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }
        
        body.dark-mode .btn-sync.has-changes::after {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%) !important;
            box-shadow: 0 8px 16px rgba(96, 165, 250, 0.5), 0 0 0 2px rgba(96, 165, 250, 0.3) !important;
        }
        
        body.dark-mode .btn-sync.has-changes::before {
            border-color: #3b82f6 transparent transparent transparent !important;
        }

        /* üé® –ì–∞—Ä–Ω–∞ —Ç–µ–º–Ω–∞ —Ç–µ–º–∞ */
        body.dark-mode .top-bar { 
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            box-shadow: 0 8px 16px -4px rgba(0,0,0,0.4);
            border: 1px solid #334155;
        }
        
        body.dark-mode .day-column { 
            background: var(--day-column-bg);
            border: 1px solid #334155;
        }
        
        body.dark-mode .day-header { 
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
            color: #93c5fd;
            border: 1px solid #475569;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .day-column.current-day {
            background: #1a1a0f;
            border-color: #854d0e;
        }
        
        body.dark-mode .lesson-card { 
            background: linear-gradient(135deg, var(--card-bg) 0%, #283548 100%);
            color: var(--text-primary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border-left-width: 4px;
        }
        
        body.dark-mode .lesson-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }
        
        body.dark-mode .lesson-card[data-type="–õ–µ–∫—Ü—ñ—è"] { border-left-color: #fb923c; }
        body.dark-mode .lesson-card[data-type="–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞"] { border-left-color: #34d399; }
        body.dark-mode .lesson-card[data-type="–ü—Ä–∞–∫—Ç–∏—á–Ω–∞"] { border-left-color: #60a5fa; }
        body.dark-mode .lesson-card[data-type="–°–µ–º—ñ–Ω–∞—Ä"] { border-left-color: #c084fc; }
        
        body.dark-mode .modal-box { 
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: var(--text-primary);
            border: 1px solid #475569;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        
        body.dark-mode .modal-header {
            color: #93c5fd;
            border-bottom: 2px solid #475569;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        
        body.dark-mode .form-input,
        body.dark-mode .form-input option { 
            background: #0f1419;
            color: var(--text-primary);
            border: 1px solid #475569;
        }
        
        body.dark-mode .form-input:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }
        
        body.dark-mode .form-label { color: #94a3b8; }
        
        body.dark-mode .btn-secondary { 
            background: #334155;
            color: #e2e8f0;
            border: 1px solid #475569;
        }
        
        body.dark-mode .btn-secondary:hover {
            background: #475569;
            transform: translateY(-1px);
        }
        
        body.dark-mode .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        body.dark-mode .btn-primary:hover {
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }
        
        body.dark-mode .time-slot { 
            background-color: var(--slot-bg);
            background-image: repeating-linear-gradient(45deg, var(--slot-bg), var(--slot-bg) 10px, var(--slot-hatch) 10px, var(--slot-hatch) 20px);
            border-color: #334155;
        }
        
        body.dark-mode .slot-number-badge { 
            background: linear-gradient(135deg, #475569 0%, #64748b 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        body.dark-mode .time-text { color: #94a3b8; }
        
        body.dark-mode .group-badge { 
            background: #334155;
            color: #93c5fd;
            border: 1px solid #475569;
        }
        
        body.dark-mode .group-badge:hover {
            background: #475569;
            border-color: #60a5fa;
        }
        
        body.dark-mode .type-badge {
            opacity: 0.9;
            font-weight: 700;
        }
        
        body.dark-mode .lesson-card[data-type="–õ–µ–∫—Ü—ñ—è"] .type-badge { 
            background: #78350f;
            color: #fbbf24;
        }
        body.dark-mode .lesson-card[data-type="–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞"] .type-badge { 
            background: #064e3b;
            color: #34d399;
        }
        body.dark-mode .lesson-card[data-type="–ü—Ä–∞–∫—Ç–∏—á–Ω–∞"] .type-badge { 
            background: #1e3a8a;
            color: #60a5fa;
        }
        body.dark-mode .lesson-card[data-type="–°–µ–º—ñ–Ω–∞—Ä"] .type-badge { 
            background: #581c87;
            color: #c084fc;
        }
        
        body.dark-mode .lesson-subject { color: #f1f5f9; }
        body.dark-mode .lesson-footer { color: var(--text-secondary); }
        
        body.dark-mode .status-badge { 
            opacity: 0.95;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        body.dark-mode .st-guest {
            background: #334155;
            color: #cbd5e1;
            border: 1px solid #475569;
        }
        
        body.dark-mode .st-admin {
            background: #1e3a8a;
            color: #93c5fd;
            border: 1px solid #3b82f6;
        }
        
        body.dark-mode .btn-sync { 
            background: linear-gradient(135deg, #334155 0%, #3f4c5e 100%);
            color: #e2e8f0;
            border: 1px solid #475569;
        }
        
        body.dark-mode .btn-sync:hover { 
            background: linear-gradient(135deg, #475569 0%, #556375 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .week-switcher { 
            background: #1e293b;
            border: 1px solid #334155;
        }
        
        body.dark-mode .week-btn { color: #64748b; }
        body.dark-mode .week-btn.active { 
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
            color: #93c5fd;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        body.dark-mode .stats-container { color: var(--text-primary); }
        
        body.dark-mode .stat-card { 
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid #475569;
            color: var(--text-primary);
        }
        
        body.dark-mode .stat-card-value { color: #93c5fd; }
        body.dark-mode .stat-title { color: #93c5fd; }
        body.dark-mode .stat-label { color: #cbd5e1; }
        
        body.dark-mode #compare-panel { 
            background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
            border: 2px solid #f59e0b;
            color: #fbbf24;
        }
        
        body.dark-mode .action-btn { 
            background: #334155;
            border: 1px solid #475569;
            color: #94a3b8;
        }
        
        body.dark-mode .action-btn:hover { 
            background: #475569;
            color: #f1f5f9;
        }
        
        body.dark-mode .add-btn-slot { color: #475569; }
        body.dark-mode .time-slot:hover .add-btn-slot { 
            color: #60a5fa;
            background: rgba(30, 41, 59, 0.8);
        }
        
        body.dark-mode .conflict-blinker {
            background-color: rgba(239, 68, 68, 0.2) !important;
            color: #fca5a5 !important;
        }
        
        body.dark-mode #darkModeToggle {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #451a03;
            border: 1px solid #fcd34d;
        }
        
        body.dark-mode #darkModeToggle:hover {
            background: linear-gradient(135deg, #fcd34d 0%, #fbbf24 100%);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        }
        
        /* –ü–æ–∫—Ä–∞—â–µ–Ω—ñ –ø—ñ–¥–∫–∞–∑–∫–∏ –¥–ª—è —Ç–µ–º–Ω–æ—ó —Ç–µ–º–∏ */
        body.dark-mode [data-tooltip]::after {
            background-color: #1e293b;
            color: #f1f5f9;
            border: 1px solid #475569;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }
        
        body.dark-mode [data-tooltip]::before {
            border-color: #1e293b transparent transparent transparent;
        }
        
        .top-bar { background: white; padding: 1rem 1.5rem; border-radius: 0.75rem; box-shadow: var(--card-shadow); margin-bottom: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem; }
        
        .top-bar-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
        .top-bar-row.first { border-bottom: 1px solid #e2e8f0; padding-bottom: 0.75rem; }
        .top-bar-row.second { justify-content: center; }
        
        .header-left { display: flex; align-items: center; gap: 15px; }
        h2 { font-size: 1.25rem; font-weight: 800; color: var(--univ-blue); margin: 0; }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .st-guest { background: #e2e8f0; color: #475569; }
        .st-admin { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }

        .cloud-status { font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; transition: all 0.3s; }
        .status-saved { color: #059669; background: #d1fae5; }
        .status-pending { color: #d97706; background: #fef3c7; }
        .status-error { color: #dc2626; background: #fee2e2; }

        .controls-right { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

        /* –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø –¢–£–¢: –î–æ–¥–∞–Ω–æ flex-wrap –¥–ª—è –≥—Ä—É–ø –∫–Ω–æ–ø–æ–∫ */
        .admin-controls { display: none; gap: 8px; align-items: center; flex-wrap: wrap; }
        .guest-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        
        .btn-sync { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; padding: 6px 12px; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.85rem; transition: all 0.2s; white-space: nowrap; }
        .btn-sync:hover { background: #e2e8f0; transform: translateY(-1px); }
        .btn-sync:disabled { opacity: 0.4; cursor: not-allowed; pointer-events: none; }
        .btn-primary { background: #3b82f6 !important; color: white !important; border-color: #3b82f6 !important; }
        .btn-primary:hover { background: #2563eb !important; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4); }
        .btn-manual-save { border-color: #bbf7d0; color: #166534; }
        .btn-manual-save:hover { background: #dcfce7; }
        .btn-export { color: #2563eb; border-color: #bfdbfe; background: #eff6ff; }
        .btn-backup { color: #4f46e5; border-color: #c7d2fe; }
        .btn-filter-active { background: #fef3c7 !important; color: #d97706 !important; border-color: #fcd34d !important; }
        .btn-filter-active:hover { background: #fde68a !important; }
        
        body.is-admin .admin-controls { display: flex; }
        body.is-admin .guest-controls { display: none; }
        body.is-admin #loginBtn { display: none; }

        .week-switcher { display: flex; background: #f1f5f9; padding: 3px; border-radius: 8px; }
        .week-btn { padding: 6px 16px; border: none; background: transparent; font-size: 0.9rem; font-weight: 700; color: #94a3b8; cursor: pointer; border-radius: 6px; transition: all 0.2s; font-family: 'Inter', sans-serif; }
        .week-btn.active { background: white; color: var(--univ-blue); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        #action-panel, #filter-panel { display: none; position: absolute; top: 110%; left: 0; right: 0; padding: 0.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 50; text-align: center; font-weight: 600; font-size: 0.9rem; align-items: center; justify-content: center; gap: 1rem; }
        #action-panel.mode-swap { background: var(--swap-mode-bg); border: 2px solid var(--swap-mode-border); color: #064e3b; }
        #action-panel.mode-move { background: var(--move-mode-bg); border: 2px solid var(--move-mode-border); color: #1e40af; }
        #action-panel.show { display: flex; }
        #filter-panel { background: #eff6ff; border: 2px solid #3b82f6; color: #1e3a8a; }
        #filter-panel.show { display: flex; }

        #compare-panel { display: none; background: #fff7ed; border: 2px solid #f97316; color: #c2410c; flex-direction: column; gap: 10px; padding: 15px; border-radius: 0.75rem; margin-bottom: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        #compare-panel.show { display: flex; }
        .compare-header { display: flex; justify-content: space-between; align-items: center; width: 100%; border-bottom: 1px solid #fed7aa; padding-bottom: 8px; }
        .compare-legend { display: flex; gap: 15px; font-size: 0.85rem; align-items: center; }
        .leg-item { display: flex; align-items: center; gap: 5px; font-weight: 600; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .compare-actions { display: flex; gap: 10px; }

        .schedule-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem; align-items: start; }
        .day-column { background: #e2e8f0; border-radius: 0.75rem; padding: 0.5rem; min-height: 80vh; display: flex; flex-direction: column; gap: 0.5rem; transition: background 0.3s; }
        .day-column.current-day { background: var(--live-bg); border: 1px solid var(--live-border); }
        .day-header { 
            text-align: center; 
            padding: 0.5rem; 
            font-weight: 700; 
            color: var(--univ-blue); 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px);
            border-radius: 0.5rem; 
            font-size: 0.95rem; 
            position: sticky; 
            top: 0; 
            z-index: 200000; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .time-slot { background-color: var(--slot-bg); background-image: repeating-linear-gradient(45deg, var(--slot-bg), var(--slot-bg) 10px, var(--slot-hatch) 10px, var(--slot-hatch) 20px); border-radius: 0.5rem; padding: 0.4rem; min-height: 90px; border: 2px dashed #cbd5e1; position: relative; transition: all 0.2s; display: flex; flex-direction: column; gap: 0.4rem; }
        .time-slot.drag-over { background-image: none; background-color: white; border-color: #3b82f6; border-style: solid; }
        
        /* –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–æ–Ω –≤ —Ä–µ–∂–∏–º–∞—Ö –º–∞–Ω—ñ–ø—É–ª—è—Ü—ñ–π */
        body.mode-move .lesson-card .group-badge,
        body.mode-move .lesson-card .teacher-row,
        body.mode-move .lesson-card .room-row,
        body.mode-move .lesson-card .card-actions,
        body.mode-swap .lesson-card .group-badge,
        body.mode-swap .lesson-card .teacher-row,
        body.mode-swap .lesson-card .room-row,
        body.mode-swap .lesson-card .card-actions,
        body.mode-duplicate .lesson-card .group-badge,
        body.mode-duplicate .lesson-card .teacher-row,
        body.mode-duplicate .lesson-card .room-row,
        body.mode-duplicate .lesson-card .card-actions {
            pointer-events: none !important;
            opacity: 0.5;
        }
        
        /* –†–µ–∂–∏–º –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è */
        body.mode-move .time-slot { cursor: pointer; }
        body.mode-move .time-slot.move-available { border-color: #3b82f6; border-style: solid; background: #eff6ff; background-image: none; }
        body.mode-move .time-slot.move-available:hover { background: #dbeafe; border-color: #2563eb; }
        body.mode-move .time-slot.move-conflict { border-color: #ef4444; border-style: solid; background: #fef2f2; background-image: none; }
        body.mode-move .time-slot.move-conflict:hover { background: #fee2e2; border-color: #dc2626; }
        body.mode-move .time-slot.move-conflict::before { 
            content: '‚ö†Ô∏è'; 
            position: absolute; 
            top: 4px; 
            right: 4px; 
            font-size: 14px;
            z-index: 10;
        }
        
        body.mode-swap .lesson-card { cursor: pointer; box-shadow: 0 0 0 2px #4ade80; }
        
        /* –†–µ–∂–∏–º –¥—É–±–ª—é–≤–∞–Ω–Ω—è */
        body.mode-duplicate .time-slot { cursor: pointer; }
        body.mode-duplicate .time-slot.duplicate-available { border-color: #22c55e; border-style: solid; background: #f0fdf4; background-image: none; }
        body.mode-duplicate .time-slot.duplicate-available:hover { background: #dcfce7; border-color: #16a34a; }
        body.mode-duplicate .time-slot.duplicate-conflict { border-color: #ef4444; border-style: solid; background: #fef2f2; background-image: none; }
        body.mode-duplicate .time-slot.duplicate-conflict:hover { background: #fee2e2; border-color: #dc2626; }
        body.mode-duplicate .time-slot.duplicate-conflict::before { 
            content: '‚ö†Ô∏è'; 
            position: absolute; 
            top: 4px; 
            right: 4px; 
            font-size: 14px;
            z-index: 10;
        }
        
        .time-slot.current-now { background-image: none; background-color: white; border: 2px solid var(--live-border); border-style: solid; box-shadow: 0 0 0 4px rgba(250, 204, 21, 0.2); }
        .time-slot.current-now::after { content: '–ó–ê–†–ê–ó'; position: absolute; bottom: 4px; right: 4px; font-size: 9px; font-weight: 800; color: var(--live-text); opacity: 0.9; pointer-events: none; }
        .time-slot.current-now .slot-number-badge { background-color: var(--live-color); }

        .slot-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .slot-number-badge { width: 20px; height: 20px; border-radius: 50%; background-color: #94a3b8; color: white; font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; }
        .time-text { font-size: 10px; font-weight: 600; color: #94a3b8; }
        .add-btn-slot { margin-top: auto; width: 100%; text-align: center; padding: 2px; border-radius: 4px; color: #cbd5e1; cursor: pointer; font-size: 16px; }
        .time-slot:hover .add-btn-slot { color: #3b82f6; background: rgba(255,255,255,0.8); }

        .lesson-card { background: white; border-radius: 0.4rem; padding: 0.5rem; cursor: grab; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; transition: transform 0.2s, opacity 0.2s, box-shadow 0.2s; border-left: 4px solid #cbd5e1; display: flex; flex-direction: column; gap: 2px; }
        .lesson-card[data-type="–õ–µ–∫—Ü—ñ—è"] { border-left-color: #f59e0b; }
        .lesson-card[data-type="–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞"] { border-left-color: #10b981; }
        .lesson-card[data-type="–ü—Ä–∞–∫—Ç–∏—á–Ω–∞"] { border-left-color: #3b82f6; }
        .lesson-card[data-type="–°–µ–º—ñ–Ω–∞—Ä"] { border-left-color: #8b5cf6; }
        .lesson-card:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 10; }
        
        body.spotlight-active .lesson-card { opacity: 0.2; pointer-events: none; filter: grayscale(0.5); }
        body.spotlight-active .lesson-card.highlighted { opacity: 1; pointer-events: auto; filter: none; transform: scale(1.03); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 50; border: 1px solid #3b82f6; }
        .lesson-card.action-source { opacity: 0.6 !important; pointer-events: none; filter: grayscale(0.8); }

        .diff-added { background-color: var(--diff-added) !important; border: 2px solid var(--diff-added-border); }
        .diff-changed { background-color: var(--diff-changed) !important; border: 2px solid var(--diff-changed-border); }
        .diff-removed { 
            background-color: var(--diff-removed) !important; 
            border: 3px solid var(--diff-removed-border) !important; 
            opacity: 0.85; 
            position: relative;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–∏—Ö –∫–∞—Ä—Ç–∫–∞—Ö –º–∞—é—Ç—å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ */
        .diff-removed .diff-actions {
            pointer-events: auto;
        }
        
        .diff-removed::after { 
            content: '–í–ò–î–ê–õ–ï–ù–û'; 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%) rotate(-12deg); 
            color: #dc2626; 
            font-weight: 900; 
            font-size: 0.75rem; 
            opacity: 0.9; 
            pointer-events: none; 
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #dc2626; 
            padding: 4px 12px; 
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
            letter-spacing: 1px;
        }
        
        body.dark-mode .diff-removed::after {
            background: rgba(30, 30, 30, 0.95);
            color: #fca5a5;
            border-color: #f87171;
            box-shadow: 0 2px 8px rgba(248, 113, 113, 0.4);
        }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –ø–µ—Ä–µ–º—ñ—â–µ–Ω–∏—Ö –ø–∞—Ä (–ø–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π –∑ –ë–£–õ–û) */
        .diff-moved-source { 
            background-color: #fed7aa !important; 
            border: 2px solid #fb923c !important; 
            opacity: 0.5; 
            filter: grayscale(0.6); 
            pointer-events: none;
            position: relative;
        }
        .diff-moved-source::after { 
            content: '–ë–£–õ–û'; 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%) rotate(-12deg); 
            color: #ea580c; 
            font-weight: 800; 
            font-size: 0.7rem; 
            opacity: 0.6; 
            pointer-events: none; 
            background: rgba(255, 255, 255, 0.6);
            border: 2px solid #fb923c; 
            padding: 3px 10px; 
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(251, 146, 60, 0.2);
        }
        
        body.dark-mode .diff-moved-source {
            background-color: #7c2d12 !important;
            border-color: #fb923c !important;
        }
        
        body.dark-mode .diff-moved-source::after {
            background: rgba(30, 30, 30, 0.9);
            color: #fdba74;
            border-color: #fb923c;
        }
        
        .diff-context { opacity: 0.4; filter: grayscale(1); pointer-events: none; }
        .diff-processed { opacity: 1; filter: none; border: 2px solid #cbd5e1; }

        @keyframes soft-pulse { 0% { background-color: transparent; } 50% { background-color: #fecaca; color: #b91c1c; } 100% { background-color: transparent; } }
        .lesson-card.conflict { border-left-color: #ef4444 !important; background-color: #fff1f2; box-shadow: 0 0 0 1px #fda4af; }
        .conflict-blinker { animation: soft-pulse 2s infinite ease-in-out; border-radius: 4px; padding: 0 4px; margin: 0 -4px; }

        .card-top-row { display: flex; align-items: center; justify-content: flex-start; gap: 8px; margin-bottom: 2px; padding-right: 20px; }
        .group-badge { font-size: 10px; font-weight: 700; color: #475569; background: #f1f5f9; padding: 1px 4px; border-radius: 3px; cursor: pointer; transition: background 0.2s; border: 1px solid transparent; max-width: 65%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; }
        .group-badge:hover { background: #e2e8f0; border-color: #cbd5e1; max-width: none; position: relative; z-index: 20; }
        .type-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; padding: 1px 5px; border-radius: 8px; }
        .lesson-card[data-type="–õ–µ–∫—Ü—ñ—è"] .type-badge { background: #fef3c7; color: #d97706; }
        .lesson-card[data-type="–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞"] .type-badge { background: #d1fae5; color: #059669; }
        .lesson-card[data-type="–ü—Ä–∞–∫—Ç–∏—á–Ω–∞"] .type-badge { background: #dbeafe; color: #2563eb; }
        .lesson-card[data-type="–°–µ–º—ñ–Ω–∞—Ä"] .type-badge { background: #ede9fe; color: #7c3aed; }
        .lesson-subject { font-size: 11px; font-weight: 700; color: #0f172a; line-height: 1.25; margin-bottom: 2px; }
        .lesson-footer { font-size: 9px; color: #64748b; display: flex; flex-direction: column; gap: 1px; }
        .info-row { display: flex; align-items: center; gap: 4px; border-radius: 2px; }
        .teacher-row { cursor: pointer; padding: 0 2px; margin-left: -2px; transition: background 0.2s; }
        .teacher-row:hover { background: #e2e8f0; color: #0f172a; }
        
        .card-actions { position: absolute; top: 4px; right: 4px; display: flex; gap: 2px; opacity: 0; transition: opacity 0.1s; }
        .lesson-card:hover .card-actions { opacity: 1; }
        .action-btn { width: 20px; height: 20px; background: white; border: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: center; border-radius: 4px; color: #94a3b8; cursor: pointer; font-size: 10px; transition: all 0.2s; }
        .action-btn:hover { border-color: #64748b; color: #0f172a; background: #f8fafc; }
        
        .btn-duplicate { color: #d97706; background: #fef3c7; border-color: #fde68a; }
        .btn-duplicate:hover { background: #fde047; color: #a16207; border-color: #fbbf24; }
        
        .btn-move { color: #3b82f6; background: #eff6ff; border-color: #bfdbfe; }
        .btn-move:hover { background: #dbeafe; color: #1d4ed8; border-color: #60a5fa; }
        
        .btn-swap { color: #8b5cf6; background: #f5f3ff; border-color: #ddd6fe; }
        .btn-swap:hover { background: #ede9fe; color: #6d28d9; border-color: #c4b5fd; }
        
        .btn-edit { color: #06b6d4; background: #ecfeff; border-color: #a5f3fc; }
        .btn-edit:hover { background: #cffafe; color: #0e7490; border-color: #67e8f9; }
        
        .btn-delete { color: #ef4444; background: #fef2f2; border-color: #fecaca; }
        .btn-delete:hover { background: #fee2e2; color: #dc2626; border-color: #fca5a5; }
        
        .mobile-actions { display: none; }
        .mobile-menu-dropdown { display: none; position: absolute; top: 25px; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 6px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 100; min-width: 150px; }
        .mobile-menu-dropdown.show { display: block; }
        .mobile-menu-item { padding: 8px 12px; font-size: 12px; font-weight: 600; color: #334155; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .mobile-menu-item:last-child { border-bottom: none; }
        .mobile-menu-item:active { background: #f8fafc; }

        .diff-actions { position: absolute; top: 4px; right: 4px; display: flex; gap: 4px; z-index: 20; }
        .btn-approve { background: #dcfce7; border: 1px solid #22c55e; color: #166534; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; cursor: pointer; }
        .btn-approve:hover { background: #22c55e; color: white; }
        .btn-reject { background: #fee2e2; border: 1px solid #ef4444; color: #991b1b; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; cursor: pointer; }
        .btn-reject:hover { background: #ef4444; color: white; }

        .note-text { font-size: 9px; color: #d97706; margin-top: 2px; font-style: italic; border-top: 1px solid #f1f5f9; padding-top: 2px;}

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 200000; }
        .modal-overlay.open { display: flex; }
        .modal-box { background: white; padding: 1.5rem; border-radius: 0.75rem; width: 380px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal-header { font-size: 1.1rem; font-weight: 700; color: var(--univ-blue); margin-bottom: 1rem; }
        .form-group { margin-bottom: 0.8rem; }
        .form-label { display: block; font-size: 0.8rem; font-weight: 600; color: #475569; margin-bottom: 0.3rem; }
        .form-input { width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-family: inherit; font-size: 0.9rem; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
        .btn { padding: 0.6rem 1.2rem; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; font-size: 0.9rem;}
        .btn-primary { background: var(--univ-blue); color: white; }
        .btn-secondary { 
            background: #f1f5f9; 
            color: #475569; 
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-secondary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(100, 116, 139, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn-secondary:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn-secondary:hover {
            background: #e2e8f0;
            color: #334155;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(71, 85, 105, 0.2);
        }
        .btn-secondary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(71, 85, 105, 0.2);
        }
        
        .btn-danger { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; }
        
        .btn-success { 
            background: #dcfce7; 
            color: #166534; 
            border: 1px solid #bbf7d0; 
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-success::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(34, 197, 94, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn-success:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn-success:hover {
            background: #bbf7d0;
            color: #14532d;
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 16px rgba(34, 197, 94, 0.3);
        }
        .btn-success:active {
            transform: translateY(0) scale(1);
            box-shadow: 0 2px 6px rgba(34, 197, 94, 0.3);
        }
        .btn-success i {
            transition: transform 0.3s ease;
        }
        .btn-success:hover i {
            transform: rotate(360deg) scale(1.2);
        }

        .stats-container { display: flex; flex-direction: column; gap: 1.5rem; max-height: 70vh; overflow-y: auto; padding-right: 5px; }
        .stat-section { border-bottom: 1px solid #e2e8f0; padding-bottom: 1rem; }
        .stat-section:last-child { border-bottom: none; }
        .stat-title { font-size: 0.9rem; font-weight: 700; color: var(--univ-blue); margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; font-size: 0.85rem; }
        .stat-label { width: 35%; color: #334155; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stat-bar-container { width: 55%; background: #f1f5f9; height: 8px; border-radius: 4px; overflow: hidden; }
        .stat-bar { height: 100%; border-radius: 4px; }
        .stat-value { width: 10%; text-align: right; font-weight: 700; color: #0f172a; }
        .bar-blue { background: #3b82f6; } .bar-green { background: #10b981; } .bar-orange { background: #f59e0b; } .bar-red { background: #ef4444; } .bar-purple { background: #8b5cf6; } .bar-gray { background: #cbd5e1; }
        
        /* –¢–∞–±–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
        .stats-tabs { display: flex; gap: 8px; margin-bottom: 1rem; border-bottom: 2px solid #e2e8f0; }
        .stats-tab { padding: 8px 16px; font-size: 0.85rem; font-weight: 600; color: #64748b; background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
        .stats-tab:hover { color: #334155; }
        .stats-tab.active { color: var(--univ-blue); border-bottom-color: var(--univ-blue); }
        .stats-tab-content { display: none; }
        .stats-tab-content.active { display: block; }
        
        /* –ö–∞—Ä—Ç–∫–∏ –¥–ª—è —à–≤–∏–¥–∫–æ—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
        .stat-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
        .stat-card { background: #f8fafc; border-radius: 8px; padding: 0.75rem; text-align: center; border: 1px solid #e2e8f0; }
        .stat-card-value { font-size: 1.5rem; font-weight: 800; color: var(--univ-blue); }
        .stat-card-label { font-size: 0.75rem; color: #64748b; margin-top: 4px; font-weight: 500; }
        
        /* –¢–µ–ø–ª–æ–≤–∞ –∫–∞—Ä—Ç–∞ */
        .heatmap { display: grid; grid-template-columns: 60px repeat(5, 1fr); gap: 4px; font-size: 0.75rem; }
        .heatmap-cell { background: #f1f5f9; padding: 8px 4px; text-align: center; border-radius: 4px; font-weight: 600; }
        .heatmap-header { background: var(--univ-blue); color: white; }
        .heatmap-time { background: #e2e8f0; color: #475569; font-size: 0.7rem; }
        .heatmap-data { cursor: pointer; transition: transform 0.2s; }
        .heatmap-data:hover { transform: scale(1.05); }
        .heat-0 { background: #f1f5f9; color: #94a3b8; }
        .heat-1 { background: #dbeafe; color: #1e40af; }
        .heat-2 { background: #93c5fd; color: #1e3a8a; }
        .heat-3 { background: #3b82f6; color: white; }
        .heat-4 { background: #1d4ed8; color: white; }
        .heat-5 { background: #1e3a8a; color: white; }
        
        /* –ö—Ä—É–≥–æ–≤–∞ –¥—ñ–∞–≥—Ä–∞–º–∞ */
        .pie-chart { width: 120px; height: 120px; border-radius: 50%; margin: 0 auto; position: relative; }
        .pie-legend { display: flex; flex-direction: column; gap: 6px; margin-top: 1rem; }
        .pie-legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; }
        .pie-legend-color { width: 16px; height: 16px; border-radius: 3px; }
        
        /* –°–ø–∏—Å–æ–∫ –∑ —ñ–∫–æ–Ω–∫–∞–º–∏ */
        .stat-list { display: flex; flex-direction: column; gap: 8px; }
        .stat-list-item { display: flex; align-items: center; gap: 10px; padding: 8px; background: #f8fafc; border-radius: 6px; font-size: 0.85rem; }
        .stat-list-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: #e2e8f0; border-radius: 50%; font-size: 0.7rem; color: #475569; flex-shrink: 0; }
        .stat-list-text { flex: 1; color: #334155; font-weight: 500; }
        .stat-list-value { font-weight: 700; color: var(--univ-blue); }
        
        /* –ü–æ—Ä–æ–∂–Ω—ñ —Å–ª–æ—Ç–∏ */
        .empty-slots { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .empty-slot-day { background: #f8fafc; border-radius: 8px; padding: 10px; border: 1px solid #e2e8f0; }
        .empty-slot-day-name { font-weight: 700; font-size: 0.8rem; color: var(--univ-blue); margin-bottom: 8px; text-align: center; }
        .empty-slot-list { display: flex; flex-direction: column; gap: 4px; }
        .empty-slot-item { background: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; text-align: center; color: #64748b; border: 1px dashed #cbd5e1; }
        
        /* –ö–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ */
        .conflict-item { background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 10px; margin-bottom: 8px; }
        .conflict-header { font-weight: 700; color: #dc2626; font-size: 0.85rem; margin-bottom: 6px; }
        .conflict-details { font-size: 0.75rem; color: #7f1d1d; line-height: 1.4; }

        /* –û–ù–û–í–õ–ï–ù–ò–ô –ë–õ–û–ö –î–õ–Ø –ú–û–ë–Ü–õ–¨–ù–ò–• */
        @media (max-width: 768px) {
            .schedule-grid { grid-template-columns: 1fr; gap: 2rem; }
            .top-bar { padding: 1rem; }
            .top-bar-row { flex-direction: column; align-items: stretch; }
            .top-bar-row.first { padding-bottom: 1rem; }
            .header-left { flex-direction: column; gap: 1rem; width: 100%; text-align: center; }
            .controls-right { width: 100%; justify-content: center; } /* –¶–µ–Ω—Ç—Ä—É—î–º–æ –∫–Ω–æ–ø–∫–∏ */
            .guest-controls, .admin-controls { justify-content: center; } /* –¶–µ–Ω—Ç—Ä—É—î–º–æ –≥—Ä—É–ø–∏ –∫–Ω–æ–ø–æ–∫ */
            .week-switcher { width: 100%; justify-content: center; }
            .modal-box { width: 90%; padding: 1rem; }
            h2 { font-size: 1.1rem; text-align: center; }
            .day-column { min-height: auto; }
            .card-actions { display: none !important; }
            .mobile-actions { display: block; position: absolute; top: 4px; right: 4px; }
            .card-top-row { padding-right: 25px; }
            
            /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å compare-panel */
            #compare-panel { padding: 10px; gap: 8px; }
            .compare-header { flex-direction: column; gap: 10px; align-items: stretch; }
            .compare-actions { flex-direction: column; width: 100%; }
            .compare-actions button { width: 100%; }
            .compare-legend { flex-wrap: wrap; gap: 10px; font-size: 0.75rem; }
            .compare-legend > div:last-child { width: 100%; margin-left: 0; margin-top: 5px; text-align: center; }
            
            /* –ü–æ–∫—Ä–∞—â–µ–Ω–∞ –ø–∞–Ω–µ–ª—å —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö */
            #filter-panel { 
                position: fixed !important;
                top: auto !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                border-radius: 0 !important;
                padding: 15px !important;
                font-size: 0.9rem !important;
                z-index: 1000 !important;
                box-shadow: 0 -6px 12px -2px rgba(0,0,0,0.2) !important;
                background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%) !important;
                color: white !important;
                border: none !important;
            }
            
            #filter-panel button {
                background: white !important;
                color: #2563eb !important;
                border: none !important;
                padding: 8px 16px !important;
                border-radius: 6px !important;
                font-weight: 700 !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            }
            
            #filter-panel #filter-msg {
                color: white !important;
                font-weight: 700 !important;
            }
            
            /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
            .stat-cards { grid-template-columns: repeat(2, 1fr); }
            .empty-slots { grid-template-columns: 1fr; }
            .heatmap { grid-template-columns: 50px repeat(5, 1fr); font-size: 0.65rem; }
            .heatmap-cell { padding: 6px 2px; }
            .stats-tabs { overflow-x: auto; }
            .stats-tab { font-size: 0.8rem; padding: 6px 12px; white-space: nowrap; }
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∏ */
        .help-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .help-section:last-child {
            border-bottom: none;
        }
        
        .help-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--univ-blue);
            margin: 0 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .help-item {
            margin-bottom: 1rem;
            padding-left: 0.5rem;
        }
        
        .help-icon-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }
        
        .help-icon {
            font-size: 1.5rem;
        }
        
        .help-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.6rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .help-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 0.5rem;
        }
        
        .help-button-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        
        .help-btn-demo {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            min-width: 32px;
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .help-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: 1px solid;
            font-size: 0.85rem;
        }
        
        .help-button-item strong {
            display: block;
            font-size: 0.9rem;
            color: var(--univ-blue);
            margin-bottom: 0.2rem;
        }
        
        .help-button-item p {
            margin: 0;
            font-size: 0.8rem;
            color: #64748b;
            line-height: 1.4;
        }
        
        .help-type-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .help-buttons-grid {
                grid-template-columns: 1fr;
            }
        }

        /* –ì–∞—Ä–Ω—ñ –ø—ñ–¥–∫–∞–∑–∫–∏ –∑–∞–º—ñ—Å—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏—Ö */
        [data-tooltip] { position: relative; cursor: pointer; }

        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%; /* –ó'—è–≤–ª—è—î—Ç—å—Å—è –∑–≤–µ—Ä—Ö—É –Ω–∞–¥ –∫–Ω–æ–ø–∫–æ—é */
            left: 50%;
            transform: translateX(-50%) translateY(5px);
            background-color: #0f172a; /* –¢–µ–º–Ω–æ-—Å–∏–Ω—ñ–π –∫–æ–ª—ñ—Ä, —è–∫ –≤ –º–µ–Ω—é */
            color: #fff;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        /* –¢—Ä–∏–∫—É—Ç–Ω–∏—á–æ–∫ –∑–Ω–∏–∑—É –ø—ñ–¥–∫–∞–∑–∫–∏ */
        [data-tooltip]::before {
            content: '';
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%) translateY(5px);
            border-width: 5px;
            border-style: solid;
            border-color: #0f172a transparent transparent transparent;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 1000;
        }

        /* –ü–æ—è–≤–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ */
        [data-tooltip]:hover::after,
        [data-tooltip]:hover::before {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        
        /* –ê–Ω—ñ–º–∞—Ü—ñ—ó –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* –ê–Ω—ñ–º–∞—Ü—ñ—è –¥–ª—è —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–º—ñ–Ω */
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7);
            }
            50% { 
                box-shadow: 0 0 0 6px rgba(250, 204, 21, 0);
            }
        }
        
        @keyframes modalBounce {
            0% { 
                opacity: 0;
                transform: scale(0.8) translateY(-20px);
            }
            50% {
                transform: scale(1.02) translateY(0);
            }
            100% { 
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        #draft-alert {
            animation: pulse-glow 2s infinite;
            transition: all 0.3s ease;
        }
        
        #draft-alert:hover {
            background: #facc15 !important;
            color: #713f12 !important;
            transform: scale(1.05);
        }
        </style>
    </head>
<body>
    
    <div id="compare-panel">
        <div class="compare-header">
            <div style="font-weight:700; display:flex; align-items:center; gap:8px;"><i class="fa-solid fa-code-compare"></i> –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ–π</div>
            <div class="compare-actions">
                <button class="btn btn-secondary" style="padding:6px 12px; font-size:0.8rem;" onclick="exitCompare()">–ó–∞–∫—Ä–∏—Ç–∏</button>
                <button class="btn btn-success" style="padding:6px 12px; font-size:0.8rem;" onclick="saveMergedChanges()"><i class="fa-solid fa-check"></i> –ó–±–µ—Ä–µ–≥—Ç–∏ –æ–±—Ä–æ–±–ª–µ–Ω—ñ –∑–º—ñ–Ω–∏</button>
            </div>
        </div>
        <div class="compare-legend">
            <div class="leg-item"><div class="dot" style="background:#22c55e;"></div> –ù–æ–≤–µ</div>
            <div class="leg-item"><div class="dot" style="background:#f97316;\"></div> –ó–º—ñ–Ω–µ–Ω–æ</div>
            <div class="leg-item"><div class="dot" style="background:#ef4444;"></div> –í–∏–¥–∞–ª–µ–Ω–æ</div>
            <div style="font-style:italic; font-size:0.8rem; margin-left:10px;">–ù–µ–æ–±—Ä–æ–±–ª–µ–Ω—ñ –∑–∞–ª–∏—à–∞—Ç—å—Å—è –≤ —á–µ—Ä–Ω–µ—Ç—Ü—ñ.</div>
        </div>
    </div>

    <div class="top-bar">
        <!-- –ü–µ—Ä—à–∏–π —Ä—è–¥–æ–∫: –ù–∞–∑–≤–∞, —Å—Ç–∞—Ç—É—Å–∏, –ø–µ—Ä–µ–º–∏–∫–∞—á —Ç–∏–∂–Ω—ñ–≤ -->
        <div class="top-bar-row first">
            <div class="header-left">
                <h2>üéì –†–æ–∑–∫–ª–∞–¥ –∫–∞—Ñ–µ–¥—Ä–∏ –ú–Ü–¢</h2>
                <div id="role-badge" class="status-badge st-guest"><i class="fa-solid fa-user"></i> –ì—ñ—Å—Ç—å</div>
                <div id="draft-alert" class="status-badge" style="display:none; background:#fef9c3; color:#a16207; border:1px solid #facc15; cursor:pointer; gap:6px; padding:6px 10px;" onclick="startCompare()">
                    <i class="fa-solid fa-bell"></i> 
                    <span id="draft-alert-text">–ó–∞–ø–∏—Ç–∏:</span>
                    <span id="draft-stats-inline" style="display:flex; gap:8px; font-size:11px; font-weight:600;">
                        <!-- –ó–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è JS -->
                    </span>
                </div>
                <div id="cloudStatus" class="cloud-status status-saved" title="–°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó">
                    <i class="fa-solid fa-cloud-check"></i> <span>–ì–æ—Ç–æ–≤–æ</span>
                </div>
            </div>
            
            <div class="week-switcher">
                <button class="week-btn active" id="btn-week-1" onclick="setWeek(1)">–¢–∏–∂–¥–µ–Ω—å I</button>
                <button class="week-btn" id="btn-week-2" onclick="setWeek(2)">–¢–∏–∂–¥–µ–Ω—å II</button>
            </div>
        </div>
        
        <!-- –î—Ä—É–≥–∏–π —Ä—è–¥–æ–∫: –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è -->
        <div class="top-bar-row second">
            <div class="controls-right">

                <div class="guest-controls">
                    <button class="btn-sync" id="reloadBtnGuest" onclick="reloadAll()" title="–û–Ω–æ–≤–∏—Ç–∏"><i class="fa-solid fa-rotate"></i></button>
                    <button class="btn-sync btn-primary" id="proposeBtnGuest" onclick="guestPropose()"><i class="fa-solid fa-paper-plane"></i>–ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –∑–º—ñ–Ω–∏</button>
                </div>

                <div class="admin-controls">
                    <button class="btn-sync" onclick="openLinksModal()" title="–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Ç–∞ PDF –¥–ª—è –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤"><i class="fa-solid fa-user-group"></i> –í–∏–∫–ª–∞–¥–∞—á—ñ</button>
                    <button class="btn-sync" id="filterBtnAdmin" onclick="toggleAdvancedSearch()" title="–ü–æ—à—É–∫ —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä–∏"><i class="fa-solid fa-filter"></i> –§—ñ–ª—å—Ç—Ä–∏</button>
                    <button class="btn-sync" onclick="openStats()" title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"><i class="fa-solid fa-chart-simple"></i></button>
                    <button class="btn-sync btn-manual-save" id="saveBtnAdmin" onclick="adminSave()"><i class="fa-solid fa-floppy-disk"></i> –ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    <button class="btn-sync btn-backup" onclick="downloadBackup()" title="–†–µ–∑–µ—Ä–≤–Ω–∞ –∫–æ–ø—ñ—è"><i class="fa-solid fa-download"></i></button>
                    <label class="btn-sync btn-backup" title="–í—ñ–¥–Ω–æ–≤–∏—Ç–∏" style="cursor: pointer;">
                        <i class="fa-solid fa-upload"></i>
                        <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="uploadBackup(this)">
                    </label>
                    <button class="btn-sync" id="reloadBtnAdmin" onclick="reloadAll()" title="–û–Ω–æ–≤–∏—Ç–∏"><i class="fa-solid fa-rotate"></i></button>
                    <button class="btn-sync" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> –í–∏—Ö—ñ–¥</button>
                </div>

                <button class="btn-sync" id="loginBtn" onclick="showLogin()"><i class="fa-solid fa-lock"></i> –í—Ö—ñ–¥</button>
                
                <button class="btn-sync" id="darkModeToggle" onclick="toggleDarkMode()" title="–¢–µ–º–Ω–∞ —Ç–µ–º–∞">
                    <i class="fa-solid fa-moon"></i>
                </button>
                <button class="btn-sync btn-export" onclick="exportToImage()" title="PNG"><i class="fa-solid fa-camera"></i></button>
                <button class="btn-sync" onclick="openHelp()" title="–î–æ–ø–æ–º–æ–≥–∞" style="color: #8b5cf6; border-color: #ddd6fe;"><i class="fa-solid fa-circle-question"></i></button>
            </div>
        </div>
        
        <div id="action-panel">
            <span id="action-msg"></span>
            <button onclick="cancelAction()" style="background:white; border:none; color:inherit; font-weight:700; padding:4px 8px; border-radius:4px; cursor:pointer;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
        
        <div id="filter-panel"><span id="filter-msg"><i class="fa-solid fa-filter"></i> –§—ñ–ª—å—Ç—Ä</span><button onclick="clearHighlight()" style="background:white; border:none; color:#1e3a8a; font-weight:700; padding:4px 8px; border-radius:4px; cursor:pointer;">–°–∫–∏–Ω—É—Ç–∏ (Esc)</button></div>
    </div>

    <div class="schedule-grid" id="schedule-container">
        <div class="day-column" id="day-1"><div class="day-header">–ü–æ–Ω–µ–¥—ñ–ª–æ–∫</div></div>
        <div class="day-column" id="day-2"><div class="day-header">–í—ñ–≤—Ç–æ—Ä–æ–∫</div></div>
        <div class="day-column" id="day-3"><div class="day-header">–°–µ—Ä–µ–¥–∞</div></div>
        <div class="day-column" id="day-4"><div class="day-header">–ß–µ—Ç–≤–µ—Ä</div></div>
        <div class="day-column" id="day-5"><div class="day-header">–ü'—è—Ç–Ω–∏—Ü—è</div></div>
    </div>

    <div class="modal-overlay" id="loginModal">
        <div class="modal-box">
            <div class="modal-header">–í—Ö—ñ–¥ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
            <div class="form-group">
                <input type="password" id="adminPass" class="form-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å" autocomplete="new-password">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeLoginModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button class="btn btn-primary" onclick="processLogin()">–£–≤—ñ–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal-box">
            <div class="modal-header" id="modalTitle">–ü–∞—Ä–∞</div>
            <div class="form-group"><label class="form-label">–ì—Ä—É–ø–∞</label><input class="form-input" type="text" id="inputGroup" list="groupsList" placeholder="–ú–ë–ê..."> <datalist id="groupsList"></datalist></div>
            <div class="form-group"><label class="form-label">–î–∏—Å—Ü–∏–ø–ª—ñ–Ω–∞</label><input class="form-input" type="text" id="inputSubject" list="subjectsList" placeholder="–ù–∞–∑–≤–∞..."><datalist id="subjectsList"></datalist></div>
            <div class="form-group"><label class="form-label">–¢–∏–ø</label><select class="form-input" id="inputType" onchange="toggleTeacher2()"><option value="–õ–µ–∫—Ü—ñ—è">–õ–µ–∫—Ü—ñ—è</option><option value="–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞</option><option value="–ü—Ä–∞–∫—Ç–∏—á–Ω–∞">–ü—Ä–∞–∫—Ç–∏—á–Ω–∞</option><option value="–°–µ–º—ñ–Ω–∞—Ä">–°–µ–º—ñ–Ω–∞—Ä</option></select></div>
            <div class="form-group"><label class="form-label">–í–∏–∫–ª–∞–¥–∞—á</label><input class="form-input" type="text" id="inputTeacher" list="teachersList" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ..."><datalist id="teachersList"></datalist></div>
            <div class="form-group" id="teacher2Group" style="display:none;"><label class="form-label">–î—Ä—É–≥–∏–π –≤–∏–∫–ª–∞–¥–∞—á</label><input class="form-input" type="text" id="inputTeacher2" list="teachersList"></div>
            <div class="form-group"><label class="form-label">–ê—É–¥–∏—Ç–æ—Ä—ñ—è</label><select class="form-input" id="inputRoomSelect" onchange="toggleCustomRoom()"></select><div id="customRoomGroup" style="display:none; margin-top:0.5rem;"><input class="form-input" type="text" id="inputRoomNumber" placeholder="–ù–æ–º–µ—Ä"></div></div>
            <div class="form-group"><label class="form-label">–ü—Ä–∏–º—ñ—Ç–∫–∞</label><textarea class="form-input" id="inputNote" style="resize:vertical; min-height:50px;"></textarea></div>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">–ó–∞–∫—Ä–∏—Ç–∏</button><button class="btn btn-primary" onclick="saveLesson()">–ó–±–µ—Ä–µ–≥—Ç–∏</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="statsModal">
        <div class="modal-box" style="width: 700px; max-width: 90vw;">
            <div class="modal-header">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–¢–∏–∂–¥–µ–Ω—å <span id="statsWeekNum"></span>)</div>
            
            <div class="stats-tabs">
                <button class="stats-tab active" onclick="switchStatsTab('general')">–ó–∞–≥–∞–ª—å–Ω–µ</button>
                <button class="stats-tab" onclick="switchStatsTab('teachers')">–í–∏–∫–ª–∞–¥–∞—á—ñ</button>
                <button class="stats-tab" onclick="switchStatsTab('rooms')">–ê—É–¥–∏—Ç–æ—Ä—ñ—ó</button>
            </div>
            
            <div class="stats-container" id="statsContent"></div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeStats()">–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –î–æ–ø–æ–º–æ–≥–∞ -->
    <div class="modal-overlay" id="helpModal" onclick="if(event.target === this) closeHelp()">
        <div class="modal-box" style="width: 800px; max-width: 95vw; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <span>üìö –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</span>
                <button class="btn btn-secondary" onclick="closeHelp()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">‚úï</button>
            </div>
            
            <div id="helpContent" style="font-size: 0.9rem; line-height: 1.6;">
                <!-- –û—Å–Ω–æ–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó -->
                <div class="help-section">
                    <h3 class="help-title">üéØ –û—Å–Ω–æ–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó</h3>
                    
                    <div class="help-item">
                        <div class="help-icon-group">
                            <span class="help-icon">üìÖ</span>
                            <strong>–ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ç–∏–∂–Ω—ñ–≤</strong>
                        </div>
                        <p>–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ <strong>–¢–∏–∂–¥–µ–Ω—å I</strong> —Ç–∞ <strong>–¢–∏–∂–¥–µ–Ω—å II</strong> –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —á–∏—Å–µ–ª—å–Ω–∏–∫–∞ —Ç–∞ –∑–Ω–∞–º–µ–Ω–Ω–∏–∫–∞.</p>
                    </div>
                    
                    <div class="help-item">
                        <div class="help-icon-group">
                            <span class="help-icon">‚ûï</span>
                            <strong>–î–æ–¥–∞–≤–∞–Ω–Ω—è –ø–∞—Ä–∏</strong>
                        </div>
                        <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –ø–æ—Ä–æ–∂–Ω—ñ–π —á–∞—Å–æ–≤–∏–π —Å–ª–æ—Ç (—Å—ñ—Ä–∞ –æ–±–ª–∞—Å—Ç—å –∑ "+") —â–æ–± –¥–æ–¥–∞—Ç–∏ –Ω–æ–≤—É –ø–∞—Ä—É.</p>
                    </div>
                    
                    <div class="help-item">
                        <div class="help-icon-group">
                            <span class="help-icon">‚úèÔ∏è</span>
                            <strong>–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø–∞—Ä–∏</strong>
                        </div>
                        <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –∫–∞—Ä—Ç–∫—É –ø–∞—Ä–∏ –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ –º–µ–Ω—é "‚ãÆ" ‚Üí "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏".</p>
                    </div>
                </div>

                <!-- –†–µ–∂–∏–º–∏ —Ä–æ–±–æ—Ç–∏ -->
                <div class="help-section">
                    <h3 class="help-title">üë§ –†–µ–∂–∏–º–∏ —Ä–æ–±–æ—Ç–∏</h3>
                    
                    <div class="help-item">
                        <div class="help-badge" style="background: #e2e8f0; color: #475569;">
                            <i class="fa-solid fa-user"></i> –ì—ñ—Å—Ç—å
                        </div>
                        <p><strong>–î–ª—è –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤:</strong> –ü–µ—Ä–µ–≥–ª—è–¥ —Ä–æ–∑–∫–ª–∞–¥—É, —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è —Ç–∞ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∑–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –∑–º—ñ–Ω–∏ –∞–¥–º—ñ–Ω—É.</p>
                    </div>
                    
                    <div class="help-item">
                        <div class="help-badge" style="background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd;">
                            <i class="fa-solid fa-user-shield"></i> –ê–¥–º—ñ–Ω
                        </div>
                        <p><strong>–î–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</strong> –ü–æ–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å ‚Äì —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è, –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è, —Å—Ö–≤–∞–ª–µ–Ω–Ω—è –∑–º—ñ–Ω –≤—ñ–¥ –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤.</p>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è (–ì—ñ—Å—Ç—å) -->
                <div class="help-section">
                    <h3 class="help-title">üîò –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è (–†–µ–∂–∏–º –ì—ñ—Å—Ç—å)</h3>
                    
                    <div class="help-buttons-grid">

                        <div class="help-button-item">
                            <span class="help-btn-demo"><i class="fa-solid fa-filter"></i></span>
                            <div>
                                <strong>–§—ñ–ª—å—Ç—Ä–∏</strong>
                                <p>–†–æ–∑—à–∏—Ä–µ–Ω–∏–π –ø–æ—à—É–∫ –ø–æ –≤–∏–∫–ª–∞–¥–∞—á–∞—Ö, –≥—Ä—É–ø–∞—Ö, –ø—Ä–µ–¥–º–µ—Ç–∞—Ö</p>
                            </div>
                        </div>
                        
                        <div class="help-button-item">
                            <span class="help-btn-demo"><i class="fa-solid fa-rotate"></i></span>
                            <div>
                                <strong>–û–Ω–æ–≤–∏—Ç–∏</strong>
                                <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–∞–π—Å–≤—ñ–∂—ñ—à—ñ –¥–∞–Ω—ñ –∑ —Ö–º–∞—Ä–∏</p>
                            </div>
                        </div>
                        
                        <div class="help-button-item">
                            <span class="help-btn-demo" style="background: #3b82f6; color: white;"><i class="fa-solid fa-paper-plane"></i></span>
                            <div>
                                <strong>–ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –∑–º—ñ–Ω–∏</strong>
                                <p>–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Å–≤–æ—ó –ø—Ä–∞–≤–∫–∏ –Ω–∞ —Ä–æ–∑–≥–ª—è–¥ –∞–¥–º—ñ–Ω—É</p>
                            </div>
                        </div>
                        
                        <div class="help-button-item">
                            <span class="help-btn-demo"><i class="fa-solid fa-lock"></i></span>
                            <div>
                                <strong>–í—Ö—ñ–¥</strong>
                                <p>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è (–ê–¥–º—ñ–Ω) -->
                <div class="help-section">
                    <h3 class="help-title">üîò –î–æ–¥–∞—Ç–∫–æ–≤—ñ –∫–Ω–æ–ø–∫–∏ (–†–µ–∂–∏–º –ê–¥–º—ñ–Ω)</h3>
                    
                    <div class="help-buttons-grid">
                        <div class="help-button-item">
                            <span class="help-btn-demo"><i class="fa-solid fa-user-group"></i></span>
                            <div>
                                <strong>–í–∏–∫–ª–∞–¥–∞—á—ñ</strong>
                                <p>–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏—Ö —Ä–æ–∑–∫–ª–∞–¥—ñ–≤ –¥–ª—è –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤ —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF</p>
                            </div>
                        </div>
                        
                        <div class="help-button-item">
                            <span class="help-btn-demo" style="background: #dcfce7; color: #166534; border-color: #bbf7d0;"><i class="fa-solid fa-floppy-disk"></i></span>
                            <div>
                                <strong>–ó–±–µ—Ä–µ–≥—Ç–∏</strong>
                                <p>–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–º—ñ–Ω —É —Ö–º–∞—Ä—É</p>
                            </div>
                        </div>
                        
                        <div class="help-button-item">
                            <span class="help-btn-demo"><i class="fa-solid fa-right-from-bracket"></i></span>
                            <div>
                                <strong>–í–∏—Ö—ñ–¥</strong>
                                <p>–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ —Ä–µ–∂–∏–º—É –≥–æ—Å—Ç—è</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –î–æ–¥–∞—Ç–∫–æ–≤—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ -->
                <div class="help-section">
                    <h3 class="help-title">üõ† –î–æ–¥–∞—Ç–∫–æ–≤—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏</h3>
                    
                    <div class="help-buttons-grid">
                        <div class="help-button-item">
                            <span class="help-btn-demo"><i class="fa-solid fa-chart-simple"></i></span>
                            <div>
                                <strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong>
                                <p>–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞: –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ—Å—Ç—å –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤, –≥—Ä—É–ø, –∞—É–¥–∏—Ç–æ—Ä—ñ–π</p>
                            </div>
                        </div>
                        
                        <div class="help-button-item">
                            <span class="help-btn-demo" style="color: #8b5cf6; border-color: #ddd6fe;"><i class="fa-solid fa-circle-question"></i></span>
                            <div>
                                <strong>–î–æ–ø–æ–º–æ–≥–∞</strong>
                                <p>–¶—è —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è :)</p>
                            </div>
                        </div>
                        
                        <div class="help-button-item">
                            <span class="help-btn-demo" style="color: #2563eb; background: #eff6ff; border-color: #bfdbfe;"><i class="fa-solid fa-camera"></i></span>
                            <div>
                                <strong>–ï–∫—Å–ø–æ—Ä—Ç PNG</strong>
                                <p>–ó–±–µ—Ä–µ–≥—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥ —è–∫ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</p>
                            </div>
                        </div>
                        
                        <div class="help-button-item">
                            <span class="help-btn-demo" style="color: #4f46e5; border-color: #c7d2fe;"><i class="fa-solid fa-download"></i></span>
                            <div>
                                <strong>–†–µ–∑–µ—Ä–≤–Ω–∞ –∫–æ–ø—ñ—è</strong>
                                <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–µ–∑–µ—Ä–≤–Ω—É –∫–æ–ø—ñ—é —Ä–æ–∑–∫–ª–∞–¥—É</p>
                            </div>
                        </div>
                        
                        <div class="help-button-item">
                            <span class="help-btn-demo" style="color: #4f46e5; border-color: #c7d2fe;"><i class="fa-solid fa-upload"></i></span>
                            <div>
                                <strong>–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è</strong>
                                <p>–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ –∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –û–ø–µ—Ä–∞—Ü—ñ—ó –∑ –ø–∞—Ä–∞–º–∏ -->
                <div class="help-section">
                    <h3 class="help-title">üé¨ –û–ø–µ—Ä–∞—Ü—ñ—ó –∑ –ø–∞—Ä–∞–º–∏</h3>
                    
                    <div class="help-item">
                        <div class="help-icon-group">
                            <span class="help-action-btn" style="color: #d97706; background: #fef3c7; border-color: #fde68a;">
                                <i class="fa-solid fa-copy"></i>
                            </span>
                            <strong>–î—É–±–ª—é–≤–∞—Ç–∏</strong>
                        </div>
                        <p>–ö–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–∞—Ä—É –Ω–∞ —ñ–Ω—à–∏–π —á–∞—Å –∞–±–æ —Ç–∏–∂–¥–µ–Ω—å.</p>
                    </div>
                    
                    <div class="help-item">
                        <div class="help-icon-group">
                            <span class="help-action-btn" style="color: #3b82f6; background: #eff6ff; border-color: #bfdbfe;">
                                <i class="fa-solid fa-arrow-right"></i>
                            </span>
                            <strong>–ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏</strong>
                        </div>
                        <p>–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –ø–∞—Ä—É –≤ —ñ–Ω—à–∏–π —á–∞—Å–æ–≤–∏–π —Å–ª–æ—Ç. –ú–æ–∂–Ω–∞ —Ç–∞–∫–æ–∂ –ø–µ—Ä–µ—Ç—è–≥–Ω—É—Ç–∏ –º–∏—à–∫–æ—é.</p>
                    </div>
                    
                    <div class="help-item">
                        <div class="help-icon-group">
                            <span class="help-action-btn" style="color: #8b5cf6; background: #f5f3ff; border-color: #ddd6fe;">
                                <i class="fa-solid fa-right-left"></i>
                            </span>
                            <strong>–ü–æ–º—ñ–Ω—è—Ç–∏ –º—ñ—Å—Ü—è–º–∏</strong>
                        </div>
                        <p>–ü–æ–º—ñ–Ω—è—Ç–∏ –¥–≤—ñ –ø–∞—Ä–∏ –º—ñ—Å—Ü—è–º–∏.</p>
                    </div>
                    
                    <div class="help-item">
                        <div class="help-icon-group">
                            <span class="help-action-btn" style="color: #06b6d4; background: #ecfeff; border-color: #a5f3fc;">
                                <i class="fa-solid fa-pen"></i>
                            </span>
                            <strong>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</strong>
                        </div>
                        <p>–ó–º—ñ–Ω–∏—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ø–∞—Ä—É.</p>
                    </div>
                    
                    <div class="help-item">
                        <div class="help-icon-group">
                            <span class="help-action-btn" style="color: #ef4444; background: #fef2f2; border-color: #fecaca;">
                                <i class="fa-solid fa-trash"></i>
                            </span>
                            <strong>–í–∏–¥–∞–ª–∏—Ç–∏</strong>
                        </div>
                        <p>–í–∏–¥–∞–ª–∏—Ç–∏ –ø–∞—Ä—É –∑ —Ä–æ–∑–∫–ª–∞–¥—É.</p>
                    </div>
                </div>

                <!-- –®–≤–∏–¥–∫—ñ —Ñ—ñ–ª—å—Ç—Ä–∏ -->
                <div class="help-section">
                    <h3 class="help-title">‚ö° –®–≤–∏–¥–∫—ñ —Ñ—ñ–ª—å—Ç—Ä–∏</h3>
                    
                    <div class="help-item">
                        <div class="help-icon-group">
                            <span class="help-icon">üë•</span>
                            <strong>–§—ñ–ª—å—Ç—Ä –ø–æ –≥—Ä—É–ø—ñ</strong>
                        </div>
                        <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –±–µ–π–¥–∂ –≥—Ä—É–ø–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "–ú–ë–ê 11") —â–æ–± –ø—ñ–¥—Å–≤—ñ—Ç–∏—Ç–∏ –≤—Å—ñ –ø–∞—Ä–∏ —Ü—ñ—î—ó –≥—Ä—É–ø–∏.</p>
                    </div>
                    
                    <div class="help-item">
                        <div class="help-icon-group">
                            <span class="help-icon">üë®‚Äçüè´</span>
                            <strong>–§—ñ–ª—å—Ç—Ä –ø–æ –≤–∏–∫–ª–∞–¥–∞—á—É</strong>
                        </div>
                        <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ —ñ–º'—è –≤–∏–∫–ª–∞–¥–∞—á–∞ —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –≤—Å—ñ –π–æ–≥–æ –ø–∞—Ä–∏.</p>
                    </div>
                    
                    <div class="help-item">
                        <p><em>–©–æ–± –≤–∏–º–∫–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ —Ö—Ä–µ—Å—Ç–∏–∫ —É —Å–∏–Ω—ñ–π –ø–∞–Ω–µ–ª—ñ –∑–≤–µ—Ä—Ö—É –∞–±–æ –∫–ª—ñ–∫–Ω—ñ—Ç—å —É –ø–æ—Ä–æ–∂–Ω—î –º—ñ—Å—Ü–µ.</em></p>
                    </div>
                </div>

                <!-- –ü—ñ–¥–∫–∞–∑–∫–∏ —Ç–∞ —Å–µ–∫—Ä–µ—Ç–∏ -->
                <div class="help-section">
                    <h3 class="help-title">üí° –ö–æ—Ä–∏—Å–Ω—ñ –ø—ñ–¥–∫–∞–∑–∫–∏</h3>
                    
                    <ul style="padding-left: 1.5rem; margin: 0.5rem 0;">
                        <li style="margin-bottom: 0.5rem;"><strong>–ü–æ—Ç–æ—á–Ω–∏–π –¥–µ–Ω—å</strong> –ø—ñ–¥—Å–≤—ñ—á—É—î—Ç—å—Å—è –∂–æ–≤—Ç–∏–º —Ñ–æ–Ω–æ–º</li>
                        <li style="margin-bottom: 0.5rem;"><strong>–ü–æ—Ç–æ—á–Ω–∞ –ø–∞—Ä–∞</strong> –º–∞—î —è—Å–∫—Ä–∞–≤—ñ—à—É —Ä–∞–º–∫—É</li>
                        <li style="margin-bottom: 0.5rem;"><strong>–ö–æ–Ω—Ñ–ª—ñ–∫—Ç–∏</strong> (—Å–ø—ñ–≤–ø–∞–¥—ñ–Ω–Ω—è –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤/–∞—É–¥–∏—Ç–æ—Ä—ñ–π) –ø–æ–∑–Ω–∞—á–∞—é—Ç—å—Å—è —á–µ—Ä–≤–æ–Ω–∏–º</li>
                        <li style="margin-bottom: 0.5rem;"><strong>–ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è</strong> –ø—Ä–∞—Ü—é—î –≤ —Ñ–æ–Ω–æ–≤–æ–º—É —Ä–µ–∂–∏–º—ñ –¥–ª—è –∞–¥–º—ñ–Ω—ñ–≤</li>
                        <li style="margin-bottom: 0.5rem;"><strong>–Ü—Å—Ç–æ—Ä—ñ—è –∑–º—ñ–Ω</strong> –∑–±–µ—Ä—ñ–≥–∞—î –¥–æ 20 –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –¥—ñ–π</li>
                        <li style="margin-bottom: 0.5rem;"><strong>Drag & Drop:</strong> –ú–æ–∂–Ω–∞ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞—Ç–∏ –ø–∞—Ä–∏ –º–∏—à–∫–æ—é –º—ñ–∂ —Å–ª–æ—Ç–∞–º–∏</li>
                    </ul>
                </div>

                <!-- –¢–∏–ø–∏ –∑–∞–Ω—è—Ç—å -->
                <div class="help-section">
                    <h3 class="help-title">üé® –¢–∏–ø–∏ –∑–∞–Ω—è—Ç—å</h3>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                        <span class="help-type-badge" style="background: #fef3c7; color: #d97706;">–õ–µ–∫—Ü—ñ—è</span>
                        <span class="help-type-badge" style="background: #d1fae5; color: #059669;">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞</span>
                        <span class="help-type-badge" style="background: #dbeafe; color: #2563eb;">–ü—Ä–∞–∫—Ç–∏—á–Ω–∞</span>
                        <span class="help-type-badge" style="background: #ede9fe; color: #7c3aed;">–°–µ–º—ñ–Ω–∞—Ä</span>
                    </div>
                </div>

                <!-- –ö–æ–Ω—Ç–∞–∫—Ç–∏ -->
                <div class="help-section" style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-top: 1.5rem;">
                    <h3 class="help-title" style="margin-top: 0;">üìß –ü–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞?</h3>
                    <p style="margin: 0.5rem 0;">–Ø–∫—â–æ —É –≤–∞—Å –≤–∏–Ω–∏–∫–ª–∏ –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –∑–Ω–∞–π—à–ª–∏ –ø–æ–º–∏–ª–∫—É, –Ω–∞–ø–∏—à—ñ—Ç—å –Ω–∞–º –Ω–∞ –∞–¥—Ä–µ—Å—É: <strong><a href="/cdn-cgi/l/" class="__cf_email__" data-cfemail="b6dfc2dbddd7d0d3d2c4d7f6d1dbd7dfda98d5d9db">itmkafedra@gmail.com</a></strong></p>
                    <p style="margin: 0.5rem 0; font-size: 0.85rem; color: #64748b;">
                        <strong>–í–µ—Ä—Å—ñ—è:</strong> 1.0 | 
                        <strong>–û–Ω–æ–≤–ª–µ–Ω–æ:</strong> –°—ñ—á–µ–Ω—å 2026
                    </p>
                    <p style="margin: 0.8rem 0 0 0; font-size: 0.8rem; color: #64748b; border-top: 1px solid #e2e8f0; padding-top: 0.8rem;">
                        ¬© 2026 –ö–∞—Ñ–µ–¥—Ä–∞ –ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç—É –Ü–¢-—Å—Ñ–µ—Ä–∏, –õ–ù–£–í–ú–ë —ñ–º–µ–Ω—ñ –°.–ó. –ì–∂–∏—Ü—å–∫–æ–≥–æ
                    </p>
                </div>
            </div>
            
            <div class="modal-actions" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                <button class="btn btn-primary" onclick="closeHelp()">–ó—Ä–æ–∑—É–º—ñ–ª–æ!</button>
            </div>
        </div>
    </div>


    <div class="modal-overlay" id="advancedSearchModal">
        <div class="modal-box" style="width: 450px;">
            <div class="modal-header">üîç –†–æ–∑—à–∏—Ä–µ–Ω–∏–π –ø–æ—à—É–∫</div>
            
            <div class="form-group">
                <label class="form-label">–í–∏–∫–ª–∞–¥–∞—á</label>
                <input class="form-input" type="text" id="advSearchTeacher" list="teachersList" placeholder="–í—Å—ñ –≤–∏–∫–ª–∞–¥–∞—á—ñ">
            </div>
            
            <div class="form-group">
                <label class="form-label">–ì—Ä—É–ø–∞</label>
                <input class="form-input" type="text" id="advSearchGroup" list="groupsList" placeholder="–í—Å—ñ –≥—Ä—É–ø–∏">
            </div>
            
            <div class="form-group">
                <label class="form-label">–ü—Ä–µ–¥–º–µ—Ç</label>
                <input class="form-input" type="text" id="advSearchSubject" list="subjectsList" placeholder="–í—Å—ñ –ø—Ä–µ–¥–º–µ—Ç–∏">
            </div>
            
            <div class="form-group">
                <label class="form-label">–¢–∏–ø –∑–∞–Ω—è—Ç—Ç—è</label>
                <select class="form-input" id="advSearchType">
                    <option value="">–í—Å—ñ —Ç–∏–ø–∏</option>
                    <option value="–õ–µ–∫—Ü—ñ—è">–õ–µ–∫—Ü—ñ—è</option>
                    <option value="–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞</option>
                    <option value="–ü—Ä–∞–∫—Ç–∏—á–Ω–∞">–ü—Ä–∞–∫—Ç–∏—á–Ω–∞</option>
                    <option value="–°–µ–º—ñ–Ω–∞—Ä">–°–µ–º—ñ–Ω–∞—Ä</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ê—É–¥–∏—Ç–æ—Ä—ñ—è</label>
                <input class="form-input" type="text" id="advSearchRoom" list="roomsList" placeholder="–í—Å—ñ –∞—É–¥–∏—Ç–æ—Ä—ñ—ó">
            </div>
            
            <div class="form-group">
                <label class="form-label">–î–µ–Ω—å —Ç–∏–∂–Ω—è</label>
                <select class="form-input" id="advSearchDay">
                    <option value="">–í—Å—ñ –¥–Ω—ñ</option>
                    <option value="1">–ü–æ–Ω–µ–¥—ñ–ª–æ–∫</option>
                    <option value="2">–í—ñ–≤—Ç–æ—Ä–æ–∫</option>
                    <option value="3">–°–µ—Ä–µ–¥–∞</option>
                    <option value="4">–ß–µ—Ç–≤–µ—Ä</option>
                    <option value="5">–ü'—è—Ç–Ω–∏—Ü—è</option>
                </select>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeAdvancedSearch()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button class="btn btn-primary" onclick="applyAdvancedSearch()">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>
    
    <datalist id="roomsList"></datalist>

    <div class="modal-overlay" id="linksModal">
        <div class="modal-box" style="width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Ç–∞ PDF –¥–ª—è –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤</div>
            <div style="overflow-y: auto; flex-grow: 1; padding-right: 5px;" id="linksListContent"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="document.getElementById('linksModal').classList.remove('open')">–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- –ö–∞—Å—Ç–æ–º–Ω–∏–π Alert/Confirm -->
    <div class="modal-overlay" id="customAlertModal">
        <div class="modal-box" style="max-width: 450px; animation: modalBounce 0.3s ease;">
            <div id="customAlertIcon" style="text-align: center; font-size: 48px; margin: 20px 0 10px 0;">
                <i class="fa-solid fa-circle-info" style="color: #3b82f6;"></i>
            </div>
            <div class="modal-header" id="customAlertTitle" style="text-align: center; font-size: 20px; padding: 10px 20px;">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</div>
            <div style="padding: 10px 30px 30px 30px; text-align: center; font-size: 15px; line-height: 1.6; color: #475569;" id="customAlertMessage"></div>
            <div class="modal-actions" id="customAlertActions" style="gap: 10px; padding: 0 20px 20px 20px;">
                <button class="btn btn-primary" onclick="closeCustomAlert(true)" style="min-width: 100px;">OK</button>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // === –í–ê–ñ–õ–ò–í–û! –í—Å—Ç–∞–≤—Ç–µ —Å—é–¥–∏ URL –í–∞—à–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ ===
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxkBploVXjfU0Z1EKg1FuB0DLeLzoaVyKaWupn_9Iu5AJyr9govQF--ppGq9JLJDKu00Q/exec';
        const ADMIN_PASSWORD = 'admin';
        
        // –ö–∞—Å—Ç–æ–º–Ω–∏–π alert/confirm
        let customAlertResolve = null;
        
        function customAlert(message, title = '–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è', type = 'info') {
            return new Promise((resolve) => {
                customAlertResolve = resolve;
                
                // –Ü–∫–æ–Ω–∫–∏ —Ç–∞ –∫–æ–ª—å–æ—Ä–∏ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Ç–∏–ø—ñ–≤
                const icons = {
                    'info': '<i class="fa-solid fa-circle-info" style="color: #3b82f6;"></i>',
                    'success': '<i class="fa-solid fa-circle-check" style="color: #22c55e;"></i>',
                    'warning': '<i class="fa-solid fa-triangle-exclamation" style="color: #f59e0b;"></i>',
                    'error': '<i class="fa-solid fa-circle-xmark" style="color: #ef4444;"></i>'
                };
                
                document.getElementById('customAlertIcon').innerHTML = icons[type] || icons['info'];
                document.getElementById('customAlertTitle').textContent = title;
                document.getElementById('customAlertMessage').textContent = message;
                document.getElementById('customAlertActions').innerHTML = '<button class="btn btn-primary" onclick="closeCustomAlert(true)" style="min-width: 100px;">OK</button>';
                document.getElementById('customAlertModal').classList.add('open');
            });
        }
        
        function customConfirm(message, title = '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è') {
            return new Promise((resolve) => {
                customAlertResolve = resolve;
                
                // –Ü–∫–æ–Ω–∫–∞ –ø–∏—Ç–∞–Ω–Ω—è –¥–ª—è confirm
                document.getElementById('customAlertIcon').innerHTML = '<i class="fa-solid fa-circle-question" style="color: #f59e0b;"></i>';
                document.getElementById('customAlertTitle').textContent = title;
                document.getElementById('customAlertMessage').textContent = message;
                document.getElementById('customAlertActions').innerHTML = '<button class="btn btn-secondary" onclick="closeCustomAlert(false)" style="min-width: 100px;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button class="btn btn-primary" onclick="closeCustomAlert(true)" style="min-width: 100px;">OK</button>';
                document.getElementById('customAlertModal').classList.add('open');
            });
        }
        
        function closeCustomAlert(result) {
            document.getElementById('customAlertModal').classList.remove('open');
            if (customAlertResolve) {
                customAlertResolve(result);
                customAlertResolve = null;
            }
        }

        // –†—ñ–∑–Ω—ñ —á–∞—Å–æ–≤—ñ —Å–ª–æ—Ç–∏ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö –¥–Ω—ñ–≤ —Ç–∏–∂–Ω—è (1=–ü–Ω, 2=–í—Ç, 3=–°—Ä, 4=–ß—Ç, 5=–ü—Ç)
        const TIME_SLOTS = {
            1: [ // –ü–æ–Ω–µ–¥—ñ–ª–æ–∫
                { id: 1, num: 1, time: "10:00 - 11:20", start: 10*60, end: 11*60+20 }, 
                { id: 2, num: 2, time: "11:35 - 12:55", start: 11*60+35, end: 12*60+55 },
                { id: 3, num: 3, time: "13:35 - 14:55", start: 13*60+35, end: 14*60+55 }, 
                { id: 4, num: 4, time: "15:10 - 16:30", start: 15*60+10, end: 16*60+30 },
                { id: 5, num: 5, time: "16:45 - 18:05", start: 16*60+45, end: 18*60+5 }
            ],
            2: [ // –í—ñ–≤—Ç–æ—Ä–æ–∫
                { id: 1, num: 1, time: "09:00 - 10:20", start: 9*60, end: 10*60+20 }, 
                { id: 2, num: 2, time: "10:35 - 11:55", start: 10*60+35, end: 11*60+55 },
                { id: 3, num: 3, time: "12:35 - 13:55", start: 12*60+35, end: 13*60+55 }, 
                { id: 4, num: 4, time: "14:10 - 15:30", start: 14*60+10, end: 15*60+30 },
                { id: 5, num: 5, time: "15:45 - 17:05", start: 15*60+45, end: 17*60+5 }
            ],
            3: [ // –°–µ—Ä–µ–¥–∞
                { id: 1, num: 1, time: "09:00 - 10:20", start: 9*60, end: 10*60+20 }, 
                { id: 2, num: 2, time: "10:35 - 11:55", start: 10*60+35, end: 11*60+55 },
                { id: 3, num: 3, time: "12:35 - 13:55", start: 12*60+35, end: 13*60+55 }, 
                { id: 4, num: 4, time: "14:10 - 15:30", start: 14*60+10, end: 15*60+30 },
                { id: 5, num: 5, time: "15:45 - 17:05", start: 15*60+45, end: 17*60+5 }
            ],
            4: [ // –ß–µ—Ç–≤–µ—Ä
                { id: 1, num: 1, time: "09:00 - 10:20", start: 9*60, end: 10*60+20 }, 
                { id: 2, num: 2, time: "10:35 - 11:55", start: 10*60+35, end: 11*60+55 },
                { id: 3, num: 3, time: "12:35 - 13:55", start: 12*60+35, end: 13*60+55 }, 
                { id: 4, num: 4, time: "14:10 - 15:30", start: 14*60+10, end: 15*60+30 },
                { id: 5, num: 5, time: "15:45 - 17:05", start: 15*60+45, end: 17*60+5 }
            ],
            5: [ // –ü'—è—Ç–Ω–∏—Ü—è
                { id: 1, num: 1, time: "09:00 - 10:20", start: 9*60, end: 10*60+20 }, 
                { id: 2, num: 2, time: "10:35 - 11:55", start: 10*60+35, end: 11*60+55 },
                { id: 3, num: 3, time: "12:10 - 13:30", start: 12*60+10, end: 13*60+30 }, 
                { id: 4, num: 4, time: "13:45 - 15:05", start: 13*60+45, end: 15*60+5 },
                { id: 5, num: 5, time: "15:20 - 16:40", start: 15*60+20, end: 16*60+40 }
            ]
        };

        let currentWeek = 1;
        let liveLessons = [];
        let draftLessons = null;
        let lessons = []; 
        let tempLiveLessons = []; 
        let processedIds = new Set(); 
        let teachersList = []; let subjectsList = []; let groupsList = []; let roomsList = [];
        
        let isAdmin = false;
        let isCompareMode = false;
        let actionState = { active: false, type: null, sourceId: null };
        let highlightState = { active: false };
        let editState = { isNew: true, lessonId: null, day: null, slot: null };
        let autoSaveTimer = null;
        let unsavedChanges = false;

        // üåô Dark Mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
            updateDarkModeIcon();
        }
        
        function updateDarkModeIcon() {
            const btn = document.getElementById('darkModeToggle');
            if (!btn) return;
            const icon = btn.querySelector('i');
            if (document.body.classList.contains('dark-mode')) {
                icon.className = 'fa-solid fa-sun';
                btn.title = '–°–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞';
            } else {
                icon.className = 'fa-solid fa-moon';
                btn.title = '–¢–µ–º–Ω–∞ —Ç–µ–º–∞';
            }
        }
        
        function initDarkMode() {
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'enabled') {
                document.body.classList.add('dark-mode');
            }
            updateDarkModeIcon();
        }
        
        // üéØ –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–æ–∑—É–º–Ω–∏—Ö –∫–Ω–æ–ø–æ–∫
        function updateButtonStates() {
            const hasChanges = hasUnsavedChanges();
            
            // –ö–Ω–æ–ø–∫–∞ "–ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –∑–º—ñ–Ω–∏" (–≥—ñ—Å—Ç—å)
            const proposeBtn = document.getElementById('proposeBtnGuest');
            if (proposeBtn) {
                if (hasChanges) {
                    proposeBtn.classList.add('has-changes');
                    proposeBtn.classList.remove('no-changes');
                    proposeBtn.disabled = false;
                    proposeBtn.removeAttribute('data-tooltip');
                    proposeBtn.removeAttribute('title');
                } else {
                    proposeBtn.classList.remove('has-changes');
                    proposeBtn.classList.add('no-changes');
                    proposeBtn.disabled = true;
                    proposeBtn.setAttribute('data-tooltip', '–ù–µ–º–∞—î –∑–º—ñ–Ω –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏');
                    proposeBtn.removeAttribute('title');
                }
            }
            
            // –ö–Ω–æ–ø–∫–∞ "–ó–±–µ—Ä–µ–≥—Ç–∏" (–∞–¥–º—ñ–Ω)
            const saveBtn = document.getElementById('saveBtnAdmin');
            if (saveBtn) {
                if (hasChanges) {
                    saveBtn.classList.add('has-changes');
                    saveBtn.classList.remove('no-changes');
                    saveBtn.disabled = false;
                    saveBtn.removeAttribute('data-tooltip');
                    saveBtn.removeAttribute('title');
                } else {
                    saveBtn.classList.remove('has-changes');
                    saveBtn.classList.add('no-changes');
                    saveBtn.disabled = true;
                    saveBtn.setAttribute('data-tooltip', '–ù–µ–º–∞—î –∑–º—ñ–Ω –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è');
                    saveBtn.removeAttribute('title');
                }
            }
        }
        
        function hasUnsavedChanges() {
            if (!liveLessons || !lessons) return false;
            if (lessons.length !== liveLessons.length) return true;
            
            for (let i = 0; i < lessons.length; i++) {
                const current = lessons[i];
                const live = liveLessons.find(l => l.id === current.id);
                
                if (!live) return true;
                
                const fields = ['group', 'subject', 'teacher', 'teacher2', 'type', 'room', 'day', 'slot', 'week', 'note'];
                for (const field of fields) {
                    if (String(current[field] || '') !== String(live[field] || '')) {
                        return true;
                    }
                }
            }
            
            return false;
        }
        
        function init() {
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Dark Mode
            initDarkMode();
            
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ readonly —Ä–µ–∂–∏–º—É –¥–ª—è –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤
            const urlParams = new URLSearchParams(window.location.search);
            const isReadOnly = urlParams.get('view') === 'readonly' || urlParams.has('teacher') || urlParams.has('group');
            
            if(isReadOnly) {
                // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –¢–Ü–õ–¨–ö–ò –∫–Ω–æ–ø–∫—É "–í—Ö—ñ–¥" –¥–ª—è –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤
                // –í–∏–∫–ª–∞–¥–∞—á—ñ –º–æ–∂—É—Ç—å –ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –∑–º—ñ–Ω–∏ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –∑–º—ñ–Ω–∏"
                const loginBtn = document.getElementById('loginBtn');
                if(loginBtn) {
                    loginBtn.style.display = 'none';
                }
                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ sessionStorage —â–æ —Ü–µ readonly —Ä–µ–∂–∏–º
                sessionStorage.setItem('readonlyMode', 'true');
            }
            
            if(localStorage.getItem('isAdmin') === 'true') setAdminMode(true);
            loadFromLocal();
            renderGrid();
            renderLessons();
            checkConflicts();
            updateLiveStatus();
            setInterval(updateLiveStatus, 30000);
            loadFromGoogle(); 
            
            // –ê–≤—Ç–æ–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–æ–≤–∏—Ö draft –∑–∞–ø–∏—Ç—ñ–≤ –¥–ª—è –∞–¥–º—ñ–Ω–∞ (–∫–æ–∂–Ω—ñ 10 —Å–µ–∫—É–Ω–¥)
            setInterval(() => {
                if (isAdmin && !isCompareMode) {
                    checkForNewDraft();
                }
            }, 10000);
            
            window.addEventListener('beforeunload', function (e) { if (unsavedChanges) { e.preventDefault(); e.returnValue = ''; } });
            document.addEventListener('dragend', () => { document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('drag-over')); });
            fixTooltips();
        }
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–æ–≤–∏—Ö draft –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—å–æ–≥–æ
        async function checkForNewDraft() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const data = await response.json();
                
                if (data.result === 'success' && data.draft) {
                    const newDraft = sanitizeData(data.draft.lessons);
                    
                    // –ü–æ—Ä—ñ–≤–Ω—é—î–º–æ –∑ –ø–æ—Ç–æ—á–Ω–∏–º draft
                    const currentDraftStr = JSON.stringify(draftLessons || []);
                    const newDraftStr = JSON.stringify(newDraft);
                    
                    if (currentDraftStr !== newDraftStr) {
                        // –Ñ –Ω–æ–≤—ñ –∑–º—ñ–Ω–∏ - –æ–Ω–æ–≤–ª—é—î–º–æ
                        draftLessons = newDraft;
                        updateDraftAlert();
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—é —è–∫—â–æ –≤ —Ä–µ–∂–∏–º—ñ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è
                        if (isCompareMode) {
                            renderLessons();
                        }
                        
                        console.log('[AUTO CHECK] –ó–Ω–∞–π–¥–µ–Ω–æ –Ω–æ–≤—ñ draft –∑–º—ñ–Ω–∏');
                    }
                }
            } catch (e) {
                // –¢–∏—Ö–æ —ñ–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫–∏ –∞–≤—Ç–æ–ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
                console.log('[AUTO CHECK] –ü–æ–º–∏–ª–∫–∞:', e.message);
            }
        }

        function fixTooltips() {
            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –∑ title
            document.querySelectorAll('[title]').forEach(el => {
                // –ü–µ—Ä–µ–Ω–æ—Å–∏–º–æ —Ç–µ–∫—Å—Ç —É –Ω–∞—à —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π –∞—Ç—Ä–∏–±—É—Ç
                el.setAttribute('data-tooltip', el.getAttribute('title'));
                // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É —Å—Ç—Ä–∞—à–Ω—É –ø—ñ–¥–∫–∞–∑–∫—É
                el.removeAttribute('title');
            });
        }
        
        function sanitizeData(data) {
            if (!Array.isArray(data)) return [];
            return data
                .map(item => {
                    const normalized = {};
                    for (const key in item) {
                        normalized[key.toLowerCase()] = item[key];
                    }
                    return normalized;
                })
                .filter(l => l && l.id)
                .map(l => ({
                    ...l,
                    week: parseInt(l.week) || 1,
                    day: parseInt(l.day) || 1,
                    slot: parseInt(l.slot) || 1,
                    note: l.note || '',
                    teacher2: l.teacher2 || '',
                    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ _deleted —è–∫—â–æ —î
                    ...(l._deleted ? { _deleted: true } : {})
                }));
        }

        function showLogin() {
            // –ë–ª–æ–∫—É—î–º–æ –≤—Ö—ñ–¥ –≤ readonly —Ä–µ–∂–∏–º—ñ
            if(sessionStorage.getItem('readonlyMode') === 'true') {
                return;
            }
            const m = document.getElementById('loginModal'); const i = document.getElementById('adminPass'); 
            m.classList.add('open'); i.value=''; i.focus(); 
            i.onkeydown = (e) => { if(e.key==='Enter') processLogin(); if(e.key==='Escape') closeLoginModal(); }; 
        }
        function closeLoginModal() { document.getElementById('loginModal').classList.remove('open'); document.getElementById('adminPass').value=''; }
        function processLogin() {
            const pass = document.getElementById('adminPass').value;
            if(pass === ADMIN_PASSWORD) {
                setAdminMode(true);
                closeLoginModal();
                reloadAll();
            } else { customAlert('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å', '–ü–æ–º–∏–ª–∫–∞', 'error'); document.getElementById('adminPass').value=''; }
        }
        function logout() {
            setAdminMode(false);
            exitCompare();
            reloadAll();
        }
        function setAdminMode(val) {
            // –ë–ª–æ–∫—É—î–º–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–¥–º—ñ–Ω —Ä–µ–∂–∏–º—É –≤ readonly
            if(sessionStorage.getItem('readonlyMode') === 'true' && val === true) {
                return;
            }
            isAdmin = val;
            localStorage.setItem('isAdmin', val);
            document.body.classList.toggle('is-admin', val);
            const badge = document.getElementById('role-badge');
            badge.className = val ? 'status-badge st-admin' : 'status-badge st-guest';
            badge.innerHTML = val ? '<i class="fa-solid fa-user-shield"></i> –ê–¥–º—ñ–Ω' : '<i class="fa-solid fa-user"></i> –ì—ñ—Å—Ç—å';
            updateDraftAlert();
        }
        
        function checkRealDifferences() {
            if (!draftLessons || draftLessons.length === 0) return false;
            if (liveLessons.length !== draftLessons.length) return true;
            const liveMap = new Map(liveLessons.map(l => [String(l.id), l]));
            const draftMap = new Map(draftLessons.map(l => [String(l.id), l]));
            for (let [id, draftL] of draftMap) {
                const liveL = liveMap.get(id);
                if (!liveL) return true;
                if (JSON.stringify(liveL) !== JSON.stringify(draftL)) return true;
            }
            for (let [id, liveL] of liveMap) {
                if (!draftMap.has(id)) return true;
            }
            return false;
        }
        
        function countDraftChanges() {
            if (!draftLessons || draftLessons.length === 0) return { total: 0, added: 0, removed: 0, modified: 0 };
            
            const liveMap = new Map(liveLessons.map(l => [String(l.id), l]));
            const draftMap = new Map(draftLessons.map(l => [String(l.id), l]));
            
            let added = 0;
            let removed = 0;
            let modified = 0;
            
            // –û–±—Ä–æ–±–ª—è—î–º–æ –≤—Å—ñ –ø–∞—Ä–∏ –∑ draft
            for (let [id, draftL] of draftMap) {
                const liveL = liveMap.get(id);
                
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –º–∞—Ä–∫–µ—Ä _deleted
                if (draftL._deleted) {
                    // –ü–∞—Ä–∞ –ø–æ–∑–Ω–∞—á–µ–Ω–∞ —è–∫ –≤–∏–¥–∞–ª–µ–Ω–∞
                    removed++;
                }
                else if (!liveL) {
                    // –ü–∞—Ä–∞ —î –≤ draft –∞–ª–µ –Ω–µ–º–∞—î –≤ live = –¥–æ–¥–∞–Ω–∞
                    added++;
                } 
                else {
                    // –û–±–∏–¥–≤—ñ —î - –ø–æ—Ä—ñ–≤–Ω—é—î–º–æ (–≤–∏–∫–ª—é—á–∞—é—á–∏ _deleted –∑ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è)
                    const liveClean = { ...liveL };
                    const draftClean = { ...draftL };
                    delete draftClean._deleted; // –ù–∞ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫
                    
                    if (JSON.stringify(liveClean) !== JSON.stringify(draftClean)) {
                        modified++;
                    }
                    // –Ø–∫—â–æ —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ - –Ω–µ —Ä–∞—Ö—É—î–º–æ (—Ü–µ context)
                }
            }
            
            const total = added + removed + modified;
            
            console.log('[COUNT] Draft changes:', { total, added, removed, modified });
            
            return { total, added, removed, modified };
        }

        function updateDraftAlert() {
            const draftAlert = document.getElementById('draft-alert');
            const statsInline = document.getElementById('draft-stats-inline');
            
            if (isAdmin && checkRealDifferences()) {
                const changes = countDraftChanges();
                
                // –§–æ—Ä–º—É—î–º–æ inline —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑ —ñ–∫–æ–Ω–∫–∞–º–∏ —Ç–∞ –∫–æ–ª—å–æ—Ä–∞–º–∏
                let statsHtml = '';
                
                if (changes.added > 0) {
                    statsHtml += `<span style="background:#dcfce7; color:#166534; padding:2px 8px; border-radius:8px; display:flex; align-items:center; gap:4px;">
                        <i class="fa-solid fa-plus" style="font-size:9px;"></i> ${changes.added}
                    </span>`;
                }
                
                if (changes.modified > 0) {
                    statsHtml += `<span style="background:#fed7aa; color:#c2410c; padding:2px 8px; border-radius:8px; display:flex; align-items:center; gap:4px;">
                        <i class="fa-solid fa-pen" style="font-size:9px;"></i> ${changes.modified}
                    </span>`;
                }
                
                if (changes.removed > 0) {
                    statsHtml += `<span style="background:#fee2e2; color:#991b1b; padding:2px 8px; border-radius:8px; display:flex; align-items:center; gap:4px;">
                        <i class="fa-solid fa-trash" style="font-size:9px;"></i> ${changes.removed}
                    </span>`;
                }
                
                statsInline.innerHTML = statsHtml;
                draftAlert.style.display = 'flex';
                
                // Pulse –∞–Ω—ñ–º–∞—Ü—ñ—è –ø—Ä–∏ –Ω–æ–≤–∏—Ö –∑–º—ñ–Ω–∞—Ö
                draftAlert.classList.remove('pulse-glow');
                void draftAlert.offsetWidth;
                draftAlert.classList.add('pulse-glow');
            } else {
                draftAlert.style.display = 'none';
            }
        }

        function loadFromLocal() {
            const data = localStorage.getItem('uni_schedule_data');
            if (data) liveLessons = sanitizeData(JSON.parse(data));
            else liveLessons = [{ id: 'l1', group: '–ü—Ä–∏–∫–ª–∞–¥', subject: '–í–≤–µ–¥—ñ—Ç—å –¥–∞–Ω—ñ', type: '–õ–µ–∫—Ü—ñ—è', teacher: '', room: '', day: 1, slot: 1, week: 1 }];
            
            lessons = JSON.parse(JSON.stringify(liveLessons));

            const tData = localStorage.getItem('uni_teachers_list'); if(tData) teachersList = JSON.parse(tData);
            const sData = localStorage.getItem('uni_subjects_list'); if(sData) subjectsList = JSON.parse(sData);
            const gData = localStorage.getItem('uni_groups_list'); if(gData) groupsList = JSON.parse(gData);
            const rData = localStorage.getItem('uni_rooms_list'); if(rData) roomsList = JSON.parse(rData);
            
            // –Ø–∫—â–æ —Å–ø–∏—Å–∫—ñ–≤ –Ω–µ–º–∞—î –≤ localStorage, –≥–µ–Ω–µ—Ä—É—î–º–æ —ó—Ö –∑ –Ω–∞—è–≤–Ω–∏—Ö –∑–∞–Ω—è—Ç—å
            if (!teachersList || teachersList.length === 0) {
                teachersList = [...new Set(liveLessons.map(l => l.teacher).filter(t => t))];
            }
            if (!subjectsList || subjectsList.length === 0) {
                subjectsList = [...new Set(liveLessons.map(l => l.subject).filter(s => s))];
            }
            if (!groupsList || groupsList.length === 0) {
                groupsList = [...new Set(liveLessons.map(l => l.group).filter(g => g))];
            }
            if (!roomsList || roomsList.length === 0) {
                roomsList = [...new Set(liveLessons.map(l => l.room).filter(r => r && typeof r === 'string' && !r.startsWith('–ê—É–¥–∏—Ç–æ—Ä—ñ—è ')))];
            }
            
            populateDatalists();
        }

        async function loadFromGoogle() {
            if(unsavedChanges && !(await customConfirm("–ù–µ–∑–±–µ—Ä–µ–∂–µ–Ω—ñ –ª–æ–∫–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–∏ –±—É–¥—É—Ç—å –≤—Ç—Ä–∞—á–µ–Ω—ñ. –û–Ω–æ–≤–∏—Ç–∏?"))) return;
            updateCloudStatus('pending', '–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...');
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const data = await response.json();
                if (data.result === 'error') throw new Error(data.error);
                
                liveLessons = sanitizeData(data.live?.lessons || []);
                let rawDraft = data.draft ? sanitizeData(data.draft.lessons) : [];
                draftLessons = (rawDraft.length > 0) ? rawDraft : null;
                
                console.log('[LOAD] Draft lessons loaded:', draftLessons ? draftLessons.length : 0);
                if (draftLessons) {
                    const deletedCount = draftLessons.filter(l => l._deleted).length;
                    console.log('[LOAD] Draft with _deleted marker:', deletedCount);
                    console.log('[LOAD] Draft deleted items:', draftLessons.filter(l => l._deleted));
                }
                
                if(data.live?.teachers) teachersList = data.live.teachers;
                if(data.live?.subjects) subjectsList = data.live.subjects;
                if(data.live?.groups) groupsList = data.live.groups;
                if(data.live?.rooms) roomsList = data.live.rooms;
                
                // –Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–¥–∞–≤ —Å–ø–∏—Å–∫–∏, –≥–µ–Ω–µ—Ä—É—î–º–æ —ó—Ö –∑ –Ω–∞—è–≤–Ω–∏—Ö –∑–∞–Ω—è—Ç—å
                if (!teachersList || teachersList.length === 0) {
                    teachersList = [...new Set(liveLessons.map(l => l.teacher).filter(t => t))];
                }
                if (!subjectsList || subjectsList.length === 0) {
                    subjectsList = [...new Set(liveLessons.map(l => l.subject).filter(s => s))];
                }
                if (!groupsList || groupsList.length === 0) {
                    groupsList = [...new Set(liveLessons.map(l => l.group).filter(g => g))];
                }
                if (!roomsList || roomsList.length === 0) {
                    roomsList = [...new Set(liveLessons.map(l => l.room).filter(r => r && typeof r === 'string' && !r.startsWith('–ê—É–¥–∏—Ç–æ—Ä—ñ—è ')))];
                }

                localStorage.setItem('uni_teachers_list', JSON.stringify(teachersList));
                localStorage.setItem('uni_groups_list', JSON.stringify(groupsList));
                localStorage.setItem('uni_subjects_list', JSON.stringify(subjectsList));
                localStorage.setItem('uni_rooms_list', JSON.stringify(roomsList));

                if (!isCompareMode) {
                    lessons = JSON.parse(JSON.stringify(liveLessons));
                }
                
                unsavedChanges = false;
                saveToLocal(); 
                populateDatalists(); renderLessons(); checkConflicts(); updateDraftAlert();
                
                // --- –î–æ–¥–∞–Ω–æ: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ ---
                checkUrlParams();

                updateCloudStatus('saved', '–û–Ω–æ–≤–ª–µ–Ω–æ');
                updateButtonStates();
            } catch (e) { console.error(e); updateCloudStatus('error', '–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è'); }
        }

        function reloadAll() { loadFromGoogle(); }

        function triggerAutoSave() { 
            unsavedChanges = true; 
            saveToLocal(); 
            updateCloudStatus('pending', '–õ–æ–∫–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–∏...'); 
            updateButtonStates();
        }
        function manualSave() { adminSave(); }
        
        function saveToLocal() {
            localStorage.setItem('uni_schedule_data', JSON.stringify(liveLessons)); 
        }

        async function guestPropose() {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –∑–º—ñ–Ω–∏
            if (!hasUnsavedChanges()) {
                return; // –¢–∏—Ö–æ –≤–∏—Ö–æ–¥–∏–º–æ, –±–æ –∫–Ω–æ–ø–∫–∞ disabled
            }
            
            if(!(await customConfirm("–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–º—ñ–Ω–∏ –Ω–∞ –∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è?"))) return;
            
            // –û–±—á–∏—Å–ª—é—î–º–æ —â–æ —Å–∞–º–µ –∑–º—ñ–Ω–∏–ª–æ—Å—å –≤—ñ–¥–Ω–æ—Å–Ω–æ liveLessons
            const changes = calculateChanges(liveLessons, lessons);
            
            console.log('[GUEST PROPOSE] Changes to send:', changes);
            console.log('[GUEST PROPOSE] Added:', changes.added.length);
            console.log('[GUEST PROPOSE] Modified:', changes.modified.length);
            console.log('[GUEST PROPOSE] Removed:', changes.removed.length);
            console.log('[GUEST PROPOSE] Removed details:', changes.removed);
            
            // –ù–∞–¥—Å–∏–ª–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –∑–º—ñ–Ω–∏ + live –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
            await sendData('propose', { 
                changes: changes,
                liveLessons: liveLessons
            });
            
            customAlert('–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—é –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ!', '–£—Å–ø—ñ—à–Ω–æ', 'success');
            unsavedChanges = false;
            reloadAll(); 
        }
        
        function calculateChanges(live, current) {
            const liveMap = new Map(live.map(l => [String(l.id), l]));
            const currentMap = new Map(current.map(l => [String(l.id), l]));
            
            const added = [];
            const modified = [];
            const removed = [];
            
            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –¥–æ–¥–∞–Ω—ñ —Ç–∞ –∑–º—ñ–Ω–µ–Ω—ñ
            for (let [id, currentLesson] of currentMap) {
                const liveLesson = liveMap.get(id);
                if (!liveLesson) {
                    // –ù–æ–≤–∞ –ø–∞—Ä–∞
                    added.push(currentLesson);
                } else if (JSON.stringify(liveLesson) !== JSON.stringify(currentLesson)) {
                    // –ó–º—ñ–Ω–µ–Ω–∞ –ø–∞—Ä–∞
                    modified.push(currentLesson);
                }
            }
            
            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤–∏–¥–∞–ª–µ–Ω—ñ
            for (let [id, liveLesson] of liveMap) {
                if (!currentMap.has(id)) {
                    // –ü–∞—Ä–∞ –±—É–ª–∞ –≤–∏–¥–∞–ª–µ–Ω–∞
                    removed.push({ id: id, _deleted: true });
                }
            }
            
            return { added, modified, removed };
        }

        async function adminSave() {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –∑–º—ñ–Ω–∏
            if (!hasUnsavedChanges()) {
                return; // –¢–∏—Ö–æ –≤–∏—Ö–æ–¥–∏–º–æ, –±–æ –∫–Ω–æ–ø–∫–∞ disabled
            }
            
            if(!(await customConfirm("–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏ —É —Ä–æ–∑–∫–ª–∞–¥?"))) return;
            await sendData('admin_save', { lessons: lessons });
            customAlert('–ó–±–µ—Ä–µ–∂–µ–Ω–æ!', '–£—Å–ø—ñ—à–Ω–æ', 'success');
            unsavedChanges = false;
            reloadAll();
        }

        async function saveMergedChanges() {
            if(!(await customConfirm("–ó–±–µ—Ä–µ–≥—Ç–∏ –æ–±—Ä–æ–±–ª–µ–Ω—ñ –∑–º—ñ–Ω–∏?"))) return;
            
            const newLive = JSON.parse(JSON.stringify(tempLiveLessons));
            const allDiffs = getDiffIds(liveLessons, draftLessons);
            let nextDraftLessons = [];

            const allProcessed = Array.from(allDiffs).every(id => processedIds.has(id));
            
            if (!allProcessed) {
                // –ó–∞–ª–∏—à–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –Ω–µ–æ–±—Ä–æ–±–ª–µ–Ω—ñ –∑–º—ñ–Ω–∏, –≤–∏–¥–∞–ª—è—î–º–æ _deleted –º–∞—Ä–∫–µ—Ä–∏ –∑ –æ–±—Ä–æ–±–ª–µ–Ω–∏—Ö
                nextDraftLessons = draftLessons.filter(lesson => {
                    const id = String(lesson.id);
                    // –Ø–∫—â–æ –æ–±—Ä–æ–±–ª–µ–Ω–æ —ñ –º–∞—î _deleted - –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ
                    if (processedIds.has(id) && lesson._deleted) {
                        return false;
                    }
                    // –Ø–∫—â–æ –æ–±—Ä–æ–±–ª–µ–Ω–æ –∞–ª–µ –±–µ–∑ _deleted - —Ç–∞–∫–æ–∂ –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ (–≤–∂–µ –≤ live)
                    if (processedIds.has(id)) {
                        return false;
                    }
                    // –ù–µ–æ–±—Ä–æ–±–ª–µ–Ω—ñ –∑–∞–ª–∏—à–∞—î–º–æ
                    return true;
                });
            }

            await sendData('commit_changes', {
                live: { lessons: newLive },
                draft: { lessons: nextDraftLessons }
            });
            
            customAlert('–ó–º—ñ–Ω–∏ —É—Å–ø—ñ—à–Ω–æ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ!', '–£—Å–ø—ñ—à–Ω–æ', 'success');
            exitCompare();
            reloadAll();
        }

        function getDiffIds(liveArr, draftArr) {
            const diffs = new Set();
            const liveMap = new Map(liveArr.map(l => [String(l.id), l]));
            const draftMap = new Map(draftArr.map(l => [String(l.id), l]));
            
            for (let [id, d] of draftMap) {
                const l = liveMap.get(id);
                if (!l || JSON.stringify(l) !== JSON.stringify(d)) diffs.add(id);
            }
            for (let [id, l] of liveMap) {
                if (!draftMap.has(id)) diffs.add(id);
            }
            return diffs;
        }

        async function rejectDraft() {
            if(!(await customConfirm("–í—ñ–¥—Ö–∏–ª–∏—Ç–∏ –í–°–Ü –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó —Ç–∞ –æ—á–∏—Å—Ç–∏—Ç–∏ —á–µ—Ä–Ω–µ—Ç–∫—É?"))) return;
            await sendData('reject', {});
            exitCompare();
            reloadAll();
        }

        async function sendData(action, payload) {
            updateCloudStatus('pending', '–í—ñ–¥–ø—Ä–∞–≤–∫–∞...');
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: action, data: payload })
                });
                const res = await response.json();
                if(res.result === 'error') throw new Error(res.error);
                updateCloudStatus('saved', '–í–∏–∫–æ–Ω–∞–Ω–æ');
            } catch(e) {
                updateCloudStatus('error', '–ü–æ–º–∏–ª–∫–∞');
                customAlert("–ü–æ–º–∏–ª–∫–∞: " + e.message, "–ü–æ–º–∏–ª–∫–∞", "error");
            }
        }

        function startCompare() {
            if(!draftLessons || draftLessons.length === 0) return;
            isCompareMode = true;
            processedIds = new Set(); 
            document.getElementById('compare-panel').classList.add('show');
            tempLiveLessons = JSON.parse(JSON.stringify(liveLessons));
            renderLessons(true); 
        }

        function exitCompare() {
            isCompareMode = false;
            document.getElementById('compare-panel').classList.remove('show');
            lessons = JSON.parse(JSON.stringify(liveLessons));
            renderLessons();
        }

        function acceptDiff(id) {
            const strId = String(id);
            const draftItem = draftLessons.find(l => String(l.id) === strId);
            
            if (draftItem) {
                if (draftItem._deleted) {
                    // –ü–∞—Ä–∞ –±—É–ª–∞ –≤–∏–¥–∞–ª–µ–Ω–∞ - –≤–∏–¥–∞–ª—è—î–º–æ –∑ tempLiveLessons
                    tempLiveLessons = tempLiveLessons.filter(l => String(l.id) !== strId);
                } else {
                    // –ü–∞—Ä–∞ –±—É–ª–∞ –¥–æ–¥–∞–Ω–∞/–∑–º—ñ–Ω–µ–Ω–∞ - –∑–∞–º—ñ–Ω—é—î–º–æ –≤ tempLiveLessons
                    tempLiveLessons = tempLiveLessons.filter(l => String(l.id) !== strId);
                    tempLiveLessons.push(draftItem);
                }
            } else {
                // –Ø–∫—â–æ –Ω–µ–º–∞—î –≤ draft - –≤–∏–¥–∞–ª—è—î–º–æ
                tempLiveLessons = tempLiveLessons.filter(l => String(l.id) !== strId);
            }
            
            processedIds.add(strId);
            renderLessons(true);
        }

        function rejectDiff(id) {
            const strId = String(id);
            const liveItem = liveLessons.find(l => String(l.id) === strId);
            
            if (liveItem) {
                tempLiveLessons = tempLiveLessons.filter(l => String(l.id) !== strId);
                tempLiveLessons.push(liveItem);
            } else {
                tempLiveLessons = tempLiveLessons.filter(l => String(l.id) !== strId);
            }
            
            processedIds.add(strId);
            renderLessons(true);
        }

        function renderLessons(doDiff = false) {
            document.querySelectorAll('.lesson-card').forEach(el => el.remove());
            
            let displayList = [];
            
            if (doDiff) {
                const draftMap = new Map((draftLessons||[]).map(l => [String(l.id), l]));
                const liveMap = new Map(liveLessons.map(l => [String(l.id), l]));
                
                console.log('[RENDER DIFF] Draft lessons:', draftLessons ? draftLessons.length : 0);
                console.log('[RENDER DIFF] Live lessons:', liveLessons.length);
                console.log('[RENDER DIFF] Draft with _deleted:', draftLessons ? draftLessons.filter(l => l._deleted).length : 0);
                
                const allIds = new Set([...draftMap.keys(), ...liveMap.keys()]);
                
                allIds.forEach(id => {
                    // --- –ù–û–í–ê –õ–û–ì–Ü–ö–ê: –Ø–∫—â–æ –æ–±—Ä–æ–±–ª–µ–Ω–æ, –ø–æ–∫–∞–∑—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç ---
                    if (processedIds.has(id)) {
                        const finalLesson = tempLiveLessons.find(l => String(l.id) === id);
                        if (finalLesson) {
                            displayList.push({ ...finalLesson, _status: 'processed' });
                        }
                        return; 
                    }
                    // --------------------------------------------------------

                    const draftL = draftMap.get(id);
                    const liveL = liveMap.get(id);
                    
                    // –õ–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –¥–µ–±–∞–≥—É
                    const hasLive = !!liveL;
                    const hasDraft = !!draftL;
                    const hasDeleted = draftL && draftL._deleted;
                    
                    if (hasDeleted || (!hasLive && hasDraft) || (hasLive && !hasDraft)) {
                        console.log(`[DIFF] ID ${id}: live=${hasLive}, draft=${hasDraft}, deleted=${hasDeleted}`);
                        if (hasDraft && draftL._deleted) {
                            console.log(`  ‚Üí REMOVED (has _deleted marker)`);
                        } else if (!hasLive && hasDraft) {
                            console.log(`  ‚Üí ADDED (in draft, not in live)`);
                        } else if (hasLive && !hasDraft) {
                            console.log(`  ‚Üí CONTEXT (in live, not in draft = no changes)`);
                        }
                    }

                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –º–∞—Ä–∫–µ—Ä _deleted –≤ draft
                    if (draftL && draftL._deleted) {
                        // –ü–∞—Ä–∞ –±—É–ª–∞ –≤–∏–¥–∞–ª–µ–Ω–∞ - –ø–æ–∫–∞–∑—É—î–º–æ live –∑ —Å—Ç–∞—Ç—É—Å–æ–º removed
                        if (liveL) {
                            displayList.push({ ...liveL, _status: 'removed' });
                        }
                    }
                    else if (!liveL && draftL) {
                        // –î–æ–¥–∞–Ω–∞ –ø–∞—Ä–∞ (—î –≤ draft –∞–ª–µ –Ω–µ–º–∞—î –≤ live)
                        displayList.push({ ...draftL, _status: 'added' });
                    }
                    else if (liveL && !draftL) {
                        // –ü–∞—Ä–∞ —î –≤ live –∞–ª–µ –Ω–µ–º–∞—î –≤ draft = –ù–ï –∑–º—ñ–Ω—é–≤–∞–ª–∞—Å—å
                        displayList.push({ ...liveL, _status: 'context' });
                    }
                    else if (liveL && draftL) {
                        // –û–±–∏–¥–≤—ñ —î - –ø–æ—Ä—ñ–≤–Ω—é—î–º–æ
                        if (JSON.stringify(liveL) !== JSON.stringify(draftL)) {
                            displayList.push({ ...draftL, _status: 'changed' });
                            displayList.push({ ...liveL, _status: 'moved-source', _ghostId: id });
                        } else {
                            displayList.push({ ...liveL, _status: 'context' });
                        }
                    }
                });
            } else {
                displayList = lessons.filter(l => parseInt(l.week) === parseInt(currentWeek));
            }

            const visible = displayList.filter(l => parseInt(l.week) === parseInt(currentWeek));

            visible.forEach(lesson => {
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –ø–∞—Ä–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Ñ—ñ–ª—å—Ç—Ä–∞–º
                if (!matchesAdvancedFilters(lesson)) {
                    return; // –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –ø–∞—Ä–∏ —â–æ –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å —Ñ—ñ–ª—å—Ç—Ä–∞–º
                }
                
                const slotEl = document.querySelector(`.time-slot[data-day="${lesson.day}"][data-slot="${lesson.slot}"]`);
                if (slotEl) {
                    const card = createCard(lesson, doDiff);
                    if (lesson._status === 'moved-source') slotEl.appendChild(card);
                    else slotEl.insertBefore(card, slotEl.querySelector('.add-btn-slot'));
                }
            });
            if(highlightState.active) reapplyHighlight();
        }

        function createCard(lesson, doDiff = false) {
            const div = document.createElement('div');
            div.className = 'lesson-card'; 
            div.draggable = !doDiff; 
            div.id = lesson._ghostId ? 'ghost-'+lesson.id : lesson.id;
            
            div.dataset.type = lesson.type; 
            div.dataset.group = lesson.group; 
            div.dataset.teacher = lesson.teacher; 
            div.dataset.teacher2 = lesson.teacher2;
            
            if (actionState.active && actionState.sourceId === lesson.id) div.classList.add('action-source');
            
            let isDiffCard = false;
            if (doDiff) {
                if (lesson._status === 'removed') { div.classList.add('diff-removed'); isDiffCard=true; }
                else if (lesson._status === 'moved-source') { div.classList.add('diff-moved-source'); isDiffCard=true; }
                else if (lesson._status==='added') { div.classList.add('diff-added'); isDiffCard=true; }
                else if (lesson._status==='changed') { div.classList.add('diff-changed'); isDiffCard=true; }
                else if (lesson._status==='context') { div.classList.add('diff-context'); isDiffCard=true; }
                else if (lesson._status==='processed') { div.classList.add('diff-processed'); isDiffCard=true; }
            }

            // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–∫–æ—Ä–æ—á–µ–Ω–Ω—è —Ç–∞ —ñ–∫–æ–Ω–∫–∏ —Ç–∏–ø—É
            const getTypeDisplay = (type) => {
                const types = {
                    '–õ–µ–∫—Ü—ñ—è': { short: '–õ–∫', icon: 'fa-chalkboard-user' },
                    '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞': { short: '–õ–∞–±', icon: 'fa-desktop' },
                    '–ü—Ä–∞–∫—Ç–∏—á–Ω–∞': { short: '–ü—Ä', icon: 'fa-laptop-code' },
                    '–°–µ–º—ñ–Ω–∞—Ä': { short: '–°–µ–º', icon: 'fa-users' }
                };
                return types[type] || { short: type, icon: 'fa-book' };
            };
            
            const typeInfo = getTypeDisplay(lesson.type);

            // –õ–æ–≥—ñ–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∞—É–¥–∏—Ç–æ—Ä—ñ—ó:
            // - –Ø–∫—â–æ "–ê—É–¥–∏—Ç–æ—Ä—ñ—è 201" ‚Üí "–ê—É–¥. 201"
            // - –Ø–∫—â–æ "–ö–æ–º–ø. –∫–ª–∞—Å 1" ‚Üí "–ö–æ–º–ø. –∫–ª–∞—Å 1" (–±–µ–∑ "–ê—É–¥.")
            // - –Ø–∫—â–æ "–ü—Ä–∞–∫—Ç–∏–∫—É–º 1" ‚Üí "–ü—Ä–∞–∫—Ç–∏–∫—É–º 1" (–±–µ–∑ "–ê—É–¥.")
            let roomDisplay = lesson.room;
            if (lesson.room && typeof lesson.room === 'string' && lesson.room.startsWith('–ê—É–¥–∏—Ç–æ—Ä—ñ—è ')) {
                // –í–∏–¥–∞–ª—è—î–º–æ "–ê—É–¥–∏—Ç–æ—Ä—ñ—è ", –¥–æ–¥–∞—î–º–æ "–ê—É–¥. "
                const roomNum = lesson.room.replace('–ê—É–¥–∏—Ç–æ—Ä—ñ—è ', '');
                roomDisplay = '–ê—É–¥. ' + roomNum;
            }
            
            let teacherDisplay = lesson.teacher; if (lesson.teacher2) teacherDisplay += `, ${lesson.teacher2}`;
            
            let actionsHtml = '';
            // --- –¢–£–¢ –ó–ú–Ü–ù–ò: –∑–∞–º—ñ—Å—Ç—å title="..." –ø–∏—à–µ–º–æ data-tooltip="..." ---
            if (!doDiff) {
                const esc = (s) => s.replace(/'/g, "\\'");
                const moveCall = `startMove('${lesson.id}', '${esc(lesson.subject)}', event); closeAllMobileMenus();`;
                const swapCall = `startSwap('${lesson.id}', '${esc(lesson.subject)}', event); closeAllMobileMenus();`;
                const editCall = `openEditById('${lesson.id}'); closeAllMobileMenus();`;
                const deleteCall = `deleteLesson('${lesson.id}', event); closeAllMobileMenus();`;

                actionsHtml = `
                <div class="card-actions">
                    <div class="action-btn btn-duplicate" data-tooltip="–î—É–±–ª—é–≤–∞—Ç–∏" onclick="duplicateLesson('${lesson.id}', event); closeAllMobileMenus();"><i class="fa-solid fa-copy"></i></div>
                    <div class="action-btn btn-move" data-tooltip="–ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏" onclick="${moveCall}"><i class="fa-solid fa-arrows-up-down-left-right"></i></div>
                    <div class="action-btn btn-swap" data-tooltip="–ü–æ–º—ñ–Ω—è—Ç–∏" onclick="${swapCall}"><i class="fa-solid fa-right-left"></i></div>
                    <div class="action-btn btn-edit" data-tooltip="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏" onclick="${editCall}"><i class="fa-solid fa-pen"></i></div>
                    <div class="action-btn btn-delete" data-tooltip="–í–∏–¥–∞–ª–∏—Ç–∏" onclick="${deleteCall}"><i class="fa-solid fa-trash"></i></div>
                </div>
                <div class="mobile-actions"><button class="action-btn" onclick="toggleMobileMenu('${lesson.id}', event)"><i class="fa-solid fa-ellipsis-vertical"></i></button><div id="menu-${lesson.id}" class="mobile-menu-dropdown"><div class="mobile-menu-item" onclick="duplicateLesson('${lesson.id}', event); closeAllMobileMenus();"><i class="fa-solid fa-copy"></i> –î—É–±–ª—é–≤–∞—Ç–∏</div><div class="mobile-menu-item" onclick="${moveCall}"><i class="fa-solid fa-arrow-up-right-from-square"></i> –ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏</div><div class="mobile-menu-item" onclick="${swapCall}"><i class="fa-solid fa-right-left"></i> –ü–æ–º—ñ–Ω—è—Ç–∏</div><div class="mobile-menu-item" onclick="${editCall}"><i class="fa-solid fa-pen"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</div><div class="mobile-menu-item" onclick="${deleteCall}" style="color: #dc2626;"><i class="fa-solid fa-trash"></i> –í–∏–¥–∞–ª–∏—Ç–∏</div></div></div>`;
            } else if (isDiffCard && !['moved-source','context','processed'].includes(lesson._status)) {
                 actionsHtml = `<div class="diff-actions"><div class="btn-approve" style="background:#dcfce7; color:#166534; width:24px; height:24px; border-radius:6px; display:flex; align-items:center; justify-content:center; cursor:pointer;" data-tooltip="–ü—Ä–∏–π–Ω—è—Ç–∏" onclick="acceptDiff('${lesson.id}')"><i class="fa-solid fa-check"></i></div><div class="btn-reject" style="background:#fee2e2; color:#991b1b; width:24px; height:24px; border-radius:6px; display:flex; align-items:center; justify-content:center; cursor:pointer;" data-tooltip="–í—ñ–¥—Ö–∏–ª–∏—Ç–∏" onclick="rejectDiff('${lesson.id}')"><i class="fa-solid fa-xmark"></i></div></div>`;
            }

            // --- –Ü –¢–£–¢ –¢–ï–ñ (–¥–ª—è –≥—Ä—É–ø): –∑–∞–º—ñ—Å—Ç—å title –ø–∏—à–µ–º–æ data-tooltip ---
            div.innerHTML = `<div class="card-top-row"><span class="group-badge" onclick="activateHighlight('group', '${lesson.group}', event)" data-tooltip="${lesson.group || ''}">${lesson.group || '-'}</span><span class="type-badge" data-tooltip="${lesson.type}"><i class="fa-solid ${typeInfo.icon}"></i> ${typeInfo.short}</span></div>${actionsHtml}<div class="lesson-subject">${lesson.subject}</div><div class="lesson-footer"><div class="info-row teacher-row" onclick="activateHighlight('teacher', '${lesson.teacher}', event)"><i class="fa-regular fa-user"></i> ${teacherDisplay}</div><div class="info-row room-row"><i class="fa-solid fa-location-dot"></i> ${roomDisplay}</div>${lesson.note ? `<div style="font-size:9px;color:#d97706;margin-top:2px;">${lesson.note}</div>` : ''}</div>`;
            
            if (!doDiff) {
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('click', (e) => {
                    if(!e.target.closest('.action-btn') && !e.target.closest('.group-badge') && !e.target.closest('.teacher-row') && !e.target.closest('.mobile-menu-item')) {
                        if (actionState.active) { if (actionState.type === 'swap') performSwap(lesson.id); else customAlert("–ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –ü–û–†–û–ñ–ù–Ü–ô —Å–ª–æ—Ç."); } else openEditModal(lesson);
                    }
                });
            }
            return div;
        }

        // --- BASIC FUNCTIONS ---
        function updateListsFromLessons() {
            // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–∫–∏ –∑ –ø–æ—Ç–æ—á–Ω–∏—Ö –∑–∞–Ω—è—Ç—å
            const newTeachers = [...new Set(lessons.map(l => l.teacher).filter(t => t))];
            const newSubjects = [...new Set(lessons.map(l => l.subject).filter(s => s))];
            const newGroups = [...new Set(lessons.map(l => l.group).filter(g => g))];
            
            // –î–ª—è –∞—É–¥–∏—Ç–æ—Ä—ñ–π –ù–ï –¥–æ–¥–∞—î–º–æ "–ê—É–¥–∏—Ç–æ—Ä—ñ—è N" - —Ç—ñ–ª—å–∫–∏ –∑–≤–∏—á–∞–π–Ω—ñ –Ω–∞–∑–≤–∏
            const newRooms = [...new Set(lessons.map(l => l.room).filter(r => r && typeof r === 'string' && !r.startsWith('–ê—É–¥–∏—Ç–æ—Ä—ñ—è ')))];
            
            // –û–±'—î–¥–Ω—É—î–º–æ –∑ —ñ—Å–Ω—É—é—á–∏–º–∏ —Å–ø–∏—Å–∫–∞–º–∏
            teachersList = [...new Set([...teachersList, ...newTeachers])].sort();
            subjectsList = [...new Set([...subjectsList, ...newSubjects])].sort();
            groupsList = [...new Set([...groupsList, ...newGroups])].sort();
            roomsList = [...new Set([...roomsList, ...newRooms])].sort();
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω—ñ —Å–ø–∏—Å–∫–∏
            localStorage.setItem('uni_teachers_list', JSON.stringify(teachersList));
            localStorage.setItem('uni_subjects_list', JSON.stringify(subjectsList));
            localStorage.setItem('uni_groups_list', JSON.stringify(groupsList));
            localStorage.setItem('uni_rooms_list', JSON.stringify(roomsList));
            
            // –û–Ω–æ–≤–ª—é—î–º–æ datalists
            populateDatalists();
        }
        function populateDatalists() { 
            const fill = (id, arr) => { 
                const el = document.getElementById(id); 
                if (!el) return;
                el.innerHTML = ''; 
                if(Array.isArray(arr)) arr.forEach(i => { 
                    const o = document.createElement('option'); 
                    o.value = i; 
                    el.appendChild(o); 
                }); 
            }; 
            fill('teachersList', teachersList); 
            fill('subjectsList', subjectsList); 
            fill('groupsList', groupsList);
            
            console.log('[DEBUG] roomsList:', roomsList);
            
            // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –∑–∞–π–≤—ñ –∑–Ω–∞—á–µ–Ω–Ω—è (—Ü–∏—Ñ—Ä–∏, –ø–æ—Ä–æ–∂–Ω—ñ —Ä—è–¥–∫–∏)
            const filteredRooms = roomsList.filter(room => {
                if (!room || typeof room !== 'string') return false;
                if (room.trim() === '') return false;
                // –í–∏–¥–∞–ª—è—î–º–æ —á–∏—Å—Ç—ñ —Ü–∏—Ñ—Ä–∏ (1, 2, 3 —Ç–æ—â–æ)
                if (/^\d+$/.test(room.trim())) return false;
                return true;
            });
            
            console.log('[DEBUG] filteredRooms:', filteredRooms);
            
            // –ó–∞–ø–æ–≤–Ω—é—î–º–æ datalist –í–Ü–î–§–Ü–õ–¨–¢–†–û–í–ê–ù–ò–ú–ò –∞—É–¥–∏—Ç–æ—Ä—ñ—è–º–∏ (–¥–ª—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤)
            fill('roomsList', filteredRooms);
            
            // –ó–∞–ø–æ–≤–Ω—é—î–º–æ select –∞—É–¥–∏—Ç–æ—Ä—ñ–π –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–∞—Ä–∏
            const roomSelect = document.getElementById('inputRoomSelect');
            if (roomSelect) {
                console.log('[DEBUG] Clearing and populating roomSelect');
                
                // –û—á–∏—â–∞—î–º–æ select
                roomSelect.innerHTML = '';
                
                // –î–æ–¥–∞—î–º–æ –±–∞–∑–æ–≤—ñ –æ–ø—Ü—ñ—ó
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.disabled = true;
                defaultOption.selected = true;
                defaultOption.textContent = '–û–±–µ—Ä—ñ—Ç—å...';
                roomSelect.appendChild(defaultOption);
                
                const auditoriumOption = document.createElement('option');
                auditoriumOption.value = 'auditorium';
                auditoriumOption.textContent = '–ê—É–¥–∏—Ç–æ—Ä—ñ—è (–Ω–æ–º–µ—Ä –≤–∫–∞–∑–∞—Ç–∏ –≤—Ä—É—á–Ω—É)';
                roomSelect.appendChild(auditoriumOption);
                
                // –î–æ–¥–∞—î–º–æ –∞—É–¥–∏—Ç–æ—Ä—ñ—ó –∑ filteredRooms
                if (Array.isArray(filteredRooms) && filteredRooms.length > 0) {
                    console.log('[DEBUG] Adding rooms from filteredRooms:', filteredRooms);
                    filteredRooms.forEach(room => {
                        console.log('[DEBUG] Adding room:', room);
                        const option = document.createElement('option');
                        option.value = room;
                        option.textContent = room;
                        roomSelect.appendChild(option);
                    });
                }
                
                console.log('[DEBUG] Final options count:', roomSelect.options.length);
                console.log('[DEBUG] Options:', Array.from(roomSelect.options).map(o => o.textContent));
            }
        }
        function updateCloudStatus(type, text) { const el = document.getElementById('cloudStatus'); el.className = 'cloud-status'; if(type === 'saved') { el.classList.add('status-saved'); el.innerHTML = `<i class="fa-solid fa-cloud-check"></i> <span>${text}</span>`; } else if (type === 'pending') { el.classList.add('status-pending'); el.innerHTML = `<i class="fa-solid fa-cloud-arrow-up"></i> <span>${text}</span>`; } else { el.classList.add('status-error'); el.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> <span>${text}</span>`; } }
        function setWeek(w) { 
            currentWeek = parseInt(w); 
            document.querySelectorAll('.week-btn').forEach(b => b.classList.remove('active')); 
            document.getElementById(`btn-week-${w}`).classList.add('active'); 
            
            renderLessons(isCompareMode); 
            checkConflicts(); 
            if(highlightState.active) reapplyHighlight();
            
            // –Ø–∫—â–æ –≤ —Ä–µ–∂–∏–º—ñ –¥—É–±–ª—é–≤–∞–Ω–Ω—è - –æ–Ω–æ–≤–ª—é—î–º–æ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–∏–∂–Ω—è
            if (duplicateState.active) {
                duplicateState.targetWeek = w;
                highlightSlotsForDuplication(duplicateState.sourceLesson);
            }
            
            // –Ø–∫—â–æ –≤ —Ä–µ–∂–∏–º—ñ –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è - –æ–Ω–æ–≤–ª—é—î–º–æ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è
            if (actionState.active && actionState.type === 'move' && actionState.sourceLesson) {
                highlightSlotsForMove(actionState.sourceLesson);
            }
        }
        function renderGrid() { const days = [1, 2, 3, 4, 5]; days.forEach(day => { const col = document.getElementById(`day-${day}`); const header = col.querySelector('.day-header'); col.innerHTML = ''; col.appendChild(header); TIME_SLOTS[day].forEach(slot => { const d = document.createElement('div'); d.className = 'time-slot'; d.dataset.day = day; d.dataset.slot = slot.id; d.innerHTML = `<div class="slot-header-row"><div class="slot-number-badge">${slot.num}</div><div class="time-text">${slot.time}</div></div><div class="add-btn-slot">+</div>`; d.addEventListener('dragover', handleDragOver); d.addEventListener('drop', handleDrop); d.addEventListener('click', (e) => handleSlotClick(day, slot.id, e)); col.appendChild(d); }); }); }
        
        function handleDragStart(e) { if(actionState.active || isCompareMode) { e.preventDefault(); return; } e.dataTransfer.setData('text/plain', this.id); actionState.type='move'; }
        function handleDragOver(e) { e.preventDefault(); if(!actionState.active && !isCompareMode) this.classList.add('drag-over'); }
        function handleDrop(e) { e.preventDefault(); this.classList.remove('drag-over'); if(isCompareMode) return; const id = e.dataTransfer.getData('text/plain'); const slotEl = e.target.closest('.time-slot'); if(id && slotEl) { const idx = lessons.findIndex(l => l.id === id); if(idx > -1) { lessons[idx].day = parseInt(slotEl.dataset.day); lessons[idx].slot = parseInt(slotEl.dataset.slot); lessons[idx].week = parseInt(currentWeek); finalizeAction(); } } }
        function startMove(id, title, e) { 
            e.stopPropagation(); 
            clearHighlight(); 
            
            const lesson = lessons.find(l => l.id === id);
            if (!lesson) return;
            
            actionState = { active: true, type: 'move', sourceId: id, sourceLesson: lesson }; 
            document.body.classList.add('mode-move'); 
            showActionPanel(`–ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è: <b>${title}</b>`, 'mode-move'); 
            renderLessons();
            
            // –ü—ñ–¥—Å–≤—ñ—á—É—î–º–æ –≤—Å—ñ —Å–ª–æ—Ç–∏
            highlightSlotsForMove(lesson);
        }
        
        function highlightSlotsForMove(sourceLesson) {
            document.querySelectorAll('.time-slot').forEach(slot => {
                const day = parseInt(slot.dataset.day);
                const slotNum = parseInt(slot.dataset.slot);
                const week = currentWeek;
                
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç—É —Å–∞–º—É –ª–æ–≥—ñ–∫—É —â–æ –¥–ª—è –¥—É–±–ª—é–≤–∞–Ω–Ω—è)
                const hasConflict = checkDuplicationConflict(sourceLesson, week, day, slotNum);
                
                if (hasConflict) {
                    slot.classList.add('move-conflict');
                } else {
                    slot.classList.add('move-available');
                }
            });
        }

        function startSwap(id, title, e) { e.stopPropagation(); clearHighlight(); actionState = { active: true, type: 'swap', sourceId: id }; document.body.classList.add('mode-swap'); showActionPanel(`–û–±–º—ñ–Ω: <b>${title}</b>`, 'mode-swap'); renderLessons(); }
        function showActionPanel(html, cssClass) { const p = document.getElementById('action-panel'); p.className = ''; p.classList.add(cssClass, 'show'); p.querySelector('span').innerHTML = html; }
        
        async function performMoveToEmpty(day, slot) { 
            const idx = lessons.findIndex(l => l.id === actionState.sourceId);
            if (idx === -1) return;
            
            const sourceLesson = lessons[idx];
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏
            const hasConflict = checkDuplicationConflict(sourceLesson, currentWeek, day, slot);
            
            if (hasConflict) {
                const conflictMessages = {
                    'group': `‚ö†Ô∏è –ö–æ–Ω—Ñ–ª—ñ–∫—Ç: –ì—Ä—É–ø–∞ ${hasConflict.lesson.group} –≤–∂–µ –º–∞—î –ø–∞—Ä—É –≤ —Ü–µ–π —á–∞—Å!\n\n${hasConflict.lesson.subject} (${hasConflict.lesson.teacher})\n\n–í—Å–µ –æ–¥–Ω–æ –ø–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏?`,
                    'teacher': `‚ö†Ô∏è –ö–æ–Ω—Ñ–ª—ñ–∫—Ç: –í–∏–∫–ª–∞–¥–∞—á ${hasConflict.lesson.teacher} –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π –≤ —Ü–µ–π —á–∞—Å!\n\n${hasConflict.lesson.subject} (${hasConflict.lesson.group})\n\n–í—Å–µ –æ–¥–Ω–æ –ø–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏?`,
                    'room': `‚ö†Ô∏è –ö–æ–Ω—Ñ–ª—ñ–∫—Ç: –ê—É–¥–∏—Ç–æ—Ä—ñ—è ${hasConflict.lesson.room} –≤–∂–µ –∑–∞–π–Ω—è—Ç–∞ –≤ —Ü–µ–π —á–∞—Å!\n\n${hasConflict.lesson.subject} (${hasConflict.lesson.teacher})\n\n–í—Å–µ –æ–¥–Ω–æ –ø–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏?`
                };
                
                if (!(await customConfirm(conflictMessages[hasConflict.type]))) {
                    return;
                }
            }
            
            // –ü–µ—Ä–µ–º—ñ—â—É—î–º–æ
            lessons[idx].day = day; 
            lessons[idx].slot = slot; 
            lessons[idx].week = parseInt(currentWeek); 
            
            finalizeAction();
        }

        function performSwap(tId) { 
            if (actionState.sourceId === tId) return; 
            const sIdx = lessons.findIndex(l => l.id === actionState.sourceId); 
            const tIdx = lessons.findIndex(l => l.id === tId); 
            if (sIdx > -1 && tIdx > -1) {
                const tmp = { d: lessons[sIdx].day, s: lessons[sIdx].slot, w: lessons[sIdx].week }; 
                lessons[sIdx].day = lessons[tIdx].day; lessons[sIdx].slot = lessons[tIdx].slot; lessons[sIdx].week = lessons[tIdx].week; 
                lessons[tIdx].day = tmp.d; lessons[tIdx].slot = tmp.s; lessons[tIdx].week = tmp.w; 
            } 
            finalizeAction(); 
        }

        function finalizeAction() { cancelAction(); triggerAutoSave(); renderLessons(); checkConflicts(); }
        function cancelAction() { 
            actionState = { active: false, type: null, sourceId: null, sourceLesson: null }; 
            document.body.classList.remove('mode-move', 'mode-swap'); 
            
            // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è —Å–ª–æ—Ç—ñ–≤
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('move-available', 'move-conflict');
            });
            
            document.getElementById('action-panel').className = ''; 
            renderLessons(); 
        }
        async function handleSlotClick(day, slot, e) { 
            if(isCompareMode) return; 
            if (e.target.closest('.lesson-card')) return; 
            
            // –Ø–∫—â–æ —Ä–µ–∂–∏–º –¥—É–±–ª—é–≤–∞–Ω–Ω—è - –Ω–µ –æ–±—Ä–æ–±–ª—è—î–º–æ —Ç—É—Ç (–æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è –≤ highlightSlotsForDuplication)
            if (duplicateState.active) return;
            
            if (actionState.active) { 
                if (actionState.type === 'move') await performMoveToEmpty(day, slot); 
                else customAlert("–í–∏ –≤ —Ä–µ–∂–∏–º—ñ –û–±–º—ñ–Ω—É. –ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –Ü–ù–®–£ –ü–ê–†–£."); 
            } else {
                // –ù–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∫–ª—ñ–∫–Ω—É–ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É "+"
                const isMobile = window.innerWidth <= 768;
                if (isMobile && !e.target.closest('.add-btn-slot')) {
                    return; // –Ü–≥–Ω–æ—Ä—É—î–º–æ –≤–∏–ø–∞–¥–∫–æ–≤—ñ —Ç–æ—Ä–∫–∞–Ω–Ω—è
                }
                openNewModal(day, slot);
            }
        }

        function checkConflicts() { document.querySelectorAll('.lesson-card').forEach(c => c.classList.remove('conflict')); document.querySelectorAll('.conflict-blinker').forEach(el => el.classList.remove('conflict-blinker')); if(isCompareMode) return; const activeLessons = lessons.filter(l => parseInt(l.week) === parseInt(currentWeek)); const slotsMap = {}; activeLessons.forEach(l => { const k = `${l.day}-${l.slot}`; if (!slotsMap[k]) slotsMap[k] = []; slotsMap[k].push(l); }); for (const key in slotsMap) { const groupLessons = slotsMap[key]; if (groupLessons.length > 1) { for (let i = 0; i < groupLessons.length; i++) { for (let j = i + 1; j < groupLessons.length; j++) { const l1 = groupLessons[i]; const l2 = groupLessons[j]; const c1 = document.getElementById(l1.id); const c2 = document.getElementById(l2.id); if(!c1 || !c2) continue; let conflictFound = false; if (l1.room && l2.room && l1.room === l2.room) { conflictFound = true; c1.querySelector('.room-row')?.classList.add('conflict-blinker'); c2.querySelector('.room-row')?.classList.add('conflict-blinker'); } const t1 = [l1.teacher, l1.teacher2].filter(t => t); const t2 = [l2.teacher, l2.teacher2].filter(t => t); if (t1.some(t => t2.includes(t))) { conflictFound = true; c1.querySelector('.teacher-row')?.classList.add('conflict-blinker'); c2.querySelector('.teacher-row')?.classList.add('conflict-blinker'); } if (l1.group && l2.group) { const g1 = l1.group.split(',').map(s => s.trim()); const g2 = l2.group.split(',').map(s => s.trim()); if (g1.some(g => g2.includes(g))) { conflictFound = true; c1.querySelector('.group-badge')?.classList.add('conflict-blinker'); c2.querySelector('.group-badge')?.classList.add('conflict-blinker'); } } if (conflictFound) { c1.classList.add('conflict'); c2.classList.add('conflict'); } } } } } }
        function toggleMobileMenu(id, e) { e.stopPropagation(); const menu = document.getElementById(`menu-${id}`); document.querySelectorAll('.mobile-menu-dropdown').forEach(m => { if(m.id !== `menu-${id}`) m.classList.remove('show'); }); menu.classList.toggle('show'); }
        function closeAllMobileMenus() { document.querySelectorAll('.mobile-menu-dropdown').forEach(m => m.classList.remove('show')); }
        function openEditById(id) { const l = lessons.find(x => x.id === id); if(l) openEditModal(l); }
        function activateHighlight(type, val, e) { 
            e.stopPropagation(); 
            if(!val) return; 
            
            // –û—á–∏—â–∞—î–º–æ —Ä–æ–∑—à–∏—Ä–µ–Ω–∏–π –ø–æ—à—É–∫, —è–∫—â–æ –≤—ñ–Ω –±—É–≤ –∞–∫—Ç–∏–≤–Ω–∏–π
            if (Object.keys(advancedSearchFilters).length > 0) {
                advancedSearchFilters = {};
                advancedSearchFiltersOriginal = {};
                updateFilterButtonState(false);
            }
            
            highlightState = { active: true, type, value: val }; 
            document.body.classList.add('spotlight-active'); 
            const p = document.getElementById('filter-panel'); 
            
            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π HTML –ø–∞–Ω–µ–ª—ñ –¥–ª—è highlight
            p.innerHTML = `<span id="filter-msg"><i class="fa-solid fa-filter"></i> ${val}</span><button onclick="clearHighlight()" style="background:white; border:none; color:#1e3a8a; font-weight:700; padding:4px 8px; border-radius:4px; cursor:pointer;">–°–∫–∏–Ω—É—Ç–∏ (Esc)</button>`;
            
            p.classList.add('show'); 
            reapplyHighlight(); 
        }
        function reapplyHighlight() { document.querySelectorAll('.lesson-card').forEach(c => { c.classList.remove('highlighted'); let match = false; if(highlightState.type === 'group' && c.dataset.group && c.dataset.group.includes(highlightState.value)) match = true; if(highlightState.type === 'teacher' && (c.dataset.teacher === highlightState.value || c.dataset.teacher2 === highlightState.value)) match = true; if(match) c.classList.add('highlighted'); }); }
        function clearHighlight() { highlightState.active = false; document.body.classList.remove('spotlight-active'); document.getElementById('filter-panel').classList.remove('show'); document.querySelectorAll('.lesson-card').forEach(c => c.classList.remove('highlighted')); }
        function handleBodyClick(e) { if(!e.target.closest('.mobile-actions')) closeAllMobileMenus(); if(highlightState.active && !e.target.closest('.lesson-card') && !e.target.closest('.top-bar') && !e.target.closest('.modal-box')) clearHighlight(); }
        function updateLiveStatus() { const now = new Date(); const d = now.getDay(); const m = now.getHours()*60 + now.getMinutes(); document.querySelectorAll('.time-slot.drag-over').forEach(el => el.classList.remove('drag-over')); document.querySelectorAll('.day-column').forEach(c => c.classList.remove('current-day')); if(d>=1 && d<=5) document.getElementById(`day-${d}`).classList.add('current-day'); document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('current-now')); if(d>=1 && d<=5) { const slot = TIME_SLOTS[d].find(s => m >= s.start && m <= s.end); if(slot) document.querySelector(`.time-slot[data-day="${d}"][data-slot="${slot.id}"]`)?.classList.add('current-now'); } }
        function exportToImage() { const el = document.getElementById('schedule-container'); const h = el.style.height; el.style.height = 'auto'; html2canvas(el, { scale: 2, backgroundColor: '#f1f5f9' }).then(c => { const a = document.createElement('a'); a.download = `schedule_week_${currentWeek}.png`; a.href = c.toDataURL(); a.click(); el.style.height = h; }); }
        function downloadBackup() { const data = JSON.stringify({ lessons, teachersList, subjectsList, groupsList, roomsList }, null, 2); const blob = new Blob([data], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        function uploadBackup(input) { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); lessons = sanitizeData(data.lessons); saveToLocal(); renderLessons(); } catch (err) { customAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É', '–ü–æ–º–∏–ª–∫–∞', 'error'); } }; reader.readAsText(file); }
        function openNewModal(d, s) { editState = { isNew: true, lessonId: null, day: d, slot: s }; clearForm(); document.getElementById('modalTitle').innerText = '–ù–æ–≤–∞ –ø–∞—Ä–∞'; document.getElementById('addModal').classList.add('open'); document.getElementById('inputGroup').focus(); }
        function openEditModal(l) { 
            editState = { isNew: false, lessonId: l.id };
            document.getElementById('modalTitle').innerText = '–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è';
            document.getElementById('inputGroup').value = l.group;
            document.getElementById('inputSubject').value = l.subject;
            document.getElementById('inputType').value = l.type;
            document.getElementById('inputTeacher').value = l.teacher;
            document.getElementById('inputTeacher2').value = l.teacher2;
            document.getElementById('inputNote').value = l.note;
            
            // –ü–∞—Ä—Å–∏–º–æ –∞—É–¥–∏—Ç–æ—Ä—ñ—é
            const sel = document.getElementById('inputRoomSelect');
            if (l.room && typeof l.room === 'string' && l.room.startsWith('–ê—É–¥–∏—Ç–æ—Ä—ñ—è ')) {
                // –¶–µ "–ê—É–¥–∏—Ç–æ—Ä—ñ—è 201"
                sel.value = 'auditorium';
                const roomNum = l.room.replace('–ê—É–¥–∏—Ç–æ—Ä—ñ—è ', '');
                document.getElementById('inputRoomNumber').value = roomNum;
            } else {
                // –¶–µ –∑–≤–∏—á–∞–π–Ω–∞ –∞—É–¥–∏—Ç–æ—Ä—ñ—è –∑—ñ —Å–ø–∏—Å–∫—É
                const option = Array.from(sel.options).find(opt => opt.value === l.room);
                if (option) {
                    sel.value = l.room;
                    document.getElementById('inputRoomNumber').value = '';
                } else {
                    // –Ø–∫—â–æ –∞—É–¥–∏—Ç–æ—Ä—ñ—ó –Ω–µ–º–∞—î –≤ —Å–ø–∏—Å–∫—É, –¥–æ–¥–∞—î–º–æ —è–∫ "–ê—É–¥–∏—Ç–æ—Ä—ñ—è"
                    sel.value = 'auditorium';
                    document.getElementById('inputRoomNumber').value = l.room;
                }
            }
            
            toggleCustomRoom();
            toggleTeacher2();
            document.getElementById('addModal').classList.add('open');
        }
        function saveLesson() { 
            const g = document.getElementById('inputGroup').value;
            const s = document.getElementById('inputSubject').value;
            const t = document.getElementById('inputTeacher').value;
            const t2 = document.getElementById('inputTeacher2').value;
            const note = document.getElementById('inputNote').value;
            const type = document.getElementById('inputType').value;
            
            let r = document.getElementById('inputRoomSelect').value;
            if(r === 'auditorium') {
                const roomNum = document.getElementById('inputRoomNumber').value;
                r = roomNum ? `–ê—É–¥–∏—Ç–æ—Ä—ñ—è ${roomNum}` : '';
            } else if (!r || r === '') {
                // –Ø–∫—â–æ –Ω–µ –≤–∏–±—Ä–∞–Ω–æ –∞—É–¥–∏—Ç–æ—Ä—ñ—é, –∑–∞–ª–∏—à–∞—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ–º
                r = '';
            }
            
            if(!s) { customAlert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É'); return; }
            
            if(editState.isNew) {
                lessons.push({ id: 'l'+Date.now(), week: currentWeek, day: editState.day, slot: editState.slot, group: g, subject: s, teacher: t, teacher2: t2, type, room: r, note });
            } else {
                const i = lessons.findIndex(l => l.id === editState.lessonId);
                if(i>-1) Object.assign(lessons[i], { group: g, subject: s, teacher: t, teacher2: t2, type, room: r, note });
            }
            
            updateListsFromLessons();
            triggerAutoSave();
            closeModal();
            renderLessons();
            checkConflicts();
        }
        async function deleteLesson(id, e) { e.stopPropagation(); if(await customConfirm('–í–∏–¥–∞–ª–∏—Ç–∏?')) { lessons = lessons.filter(l=>l.id!==id); triggerAutoSave(); renderLessons(); checkConflicts(); } }
        
        let duplicateState = {
            active: false,
            sourceLesson: null,
            targetWeek: 1  // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∏–∂–¥–µ–Ω—å
        };
        
        function duplicateLesson(id, e) {
            e.stopPropagation();
            const lesson = lessons.find(l => l.id === id);
            if (!lesson) return;
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–∞–Ω—ñ –¥–ª—è –¥—É–±–ª—é–≤–∞–Ω–Ω—è
            duplicateState = {
                active: true,
                sourceLesson: { ...lesson },
                targetWeek: currentWeek  // –°–ø–æ—á–∞—Ç–∫—É –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Ç–∏–∂–¥–µ–Ω—å
            };
            
            // –í–º–∏–∫–∞—î–º–æ —Ä–µ–∂–∏–º –¥—É–±–ª—é–≤–∞–Ω–Ω—è
            document.body.classList.add('mode-duplicate');
            
            // –ü—ñ–¥—Å–≤—ñ—á—É—î–º–æ –≤—Å—ñ —Å–ª–æ—Ç–∏
            highlightSlotsForDuplication(lesson);
        }
        
        function highlightSlotsForDuplication(sourceLesson) {
            // –°–ø–æ—á–∞—Ç–∫—É –ø—Ä–∏–±–∏—Ä–∞—î–º–æ —Å—Ç–∞—Ä–µ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('duplicate-available', 'duplicate-conflict');
                slot.onclick = null;
            });
            
            document.querySelectorAll('.time-slot').forEach(slot => {
                const day = parseInt(slot.dataset.day);
                const slotNum = parseInt(slot.dataset.slot);
                const week = duplicateState.targetWeek;
                
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏
                const hasConflict = checkDuplicationConflict(sourceLesson, week, day, slotNum);
                
                if (hasConflict) {
                    slot.classList.add('duplicate-conflict');
                } else {
                    slot.classList.add('duplicate-available');
                }
                
                // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É
                slot.onclick = (e) => {
                    if (!duplicateState.active) return;
                    if (e.target.closest('.lesson-card') || e.target.closest('.add-btn-slot')) return;
                    executeDuplicationToSlot(week, day, slotNum, hasConflict);
                };
            });
        }
        
        function checkDuplicationConflict(sourceLesson, targetWeek, targetDay, targetSlot) {
            // –ö–æ–Ω—Ñ–ª—ñ–∫—Ç —è–∫—â–æ:
            // 1. –¢–∞ –∂ –≥—Ä—É–ø–∞ –≤ —Ç–æ–π –∂–µ —á–∞—Å
            // 2. –¢–æ–π –∂–µ –≤–∏–∫–ª–∞–¥–∞—á –≤ —Ç–æ–π –∂–µ —á–∞—Å
            // 3. –¢–∞ –∂ –∞—É–¥–∏—Ç–æ—Ä—ñ—è –≤ —Ç–æ–π –∂–µ —á–∞—Å (–¥–ª—è –ª–µ–∫—Ü—ñ–π)
            
            const conflicts = lessons.filter(l => 
                l.week === targetWeek && 
                l.day === targetDay && 
                l.slot === targetSlot
            );
            
            for (const existing of conflicts) {
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≥—Ä—É–ø–∏
                if (sourceLesson.group && existing.group === sourceLesson.group) {
                    return { type: 'group', lesson: existing };
                }
                
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∏–∫–ª–∞–¥–∞—á–∞
                if (sourceLesson.teacher && 
                    (existing.teacher === sourceLesson.teacher || existing.teacher2 === sourceLesson.teacher)) {
                    return { type: 'teacher', lesson: existing };
                }
                if (sourceLesson.teacher2 && 
                    (existing.teacher === sourceLesson.teacher2 || existing.teacher2 === sourceLesson.teacher2)) {
                    return { type: 'teacher', lesson: existing };
                }
                
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞—É–¥–∏—Ç–æ—Ä—ñ—ó (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –ª–µ–∫—Ü—ñ–π)
                if (sourceLesson.type === '–õ–µ–∫—Ü—ñ—è' && existing.type === '–õ–µ–∫—Ü—ñ—è' && 
                    sourceLesson.room && existing.room === sourceLesson.room) {
                    return { type: 'room', lesson: existing };
                }
            }
            
            return false;
        }
        
        function executeDuplicationToSlot(targetWeek, targetDay, targetSlot, conflict) {
            if (!duplicateState.active || !duplicateState.sourceLesson) return;
            
            // –Ø–∫—â–æ —î –∫–æ–Ω—Ñ–ª—ñ–∫—Ç - –ø–æ–ø–µ—Ä–µ–¥–∂–∞—î–º–æ
            if (conflict) {
                const conflictMessages = {
                    'group': `‚ö†Ô∏è –ö–æ–Ω—Ñ–ª—ñ–∫—Ç: –ì—Ä—É–ø–∞ ${conflict.lesson.group} –≤–∂–µ –º–∞—î –ø–∞—Ä—É –≤ —Ü–µ–π —á–∞—Å!\n\n${conflict.lesson.subject} (${conflict.lesson.teacher})\n\n–í—Å–µ –æ–¥–Ω–æ –¥–æ–¥–∞—Ç–∏?`,
                    'teacher': `‚ö†Ô∏è –ö–æ–Ω—Ñ–ª—ñ–∫—Ç: –í–∏–∫–ª–∞–¥–∞—á ${conflict.lesson.teacher} –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π –≤ —Ü–µ–π —á–∞—Å!\n\n${conflict.lesson.subject} (${conflict.lesson.group})\n\n–í—Å–µ –æ–¥–Ω–æ –¥–æ–¥–∞—Ç–∏?`,
                    'room': `‚ö†Ô∏è –ö–æ–Ω—Ñ–ª—ñ–∫—Ç: –ê—É–¥–∏—Ç–æ—Ä—ñ—è ${conflict.lesson.room} –≤–∂–µ –∑–∞–π–Ω—è—Ç–∞ –≤ —Ü–µ–π —á–∞—Å!\n\n${conflict.lesson.subject} (${conflict.lesson.teacher})\n\n–í—Å–µ –æ–¥–Ω–æ –¥–æ–¥–∞—Ç–∏?`
                };
                
                if (!confirm(conflictMessages[conflict.type])) {
                    return;
                }
            }
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—É –ø–∞—Ä—É
            const newLesson = {
                ...duplicateState.sourceLesson,
                id: 'l' + Date.now() + Math.random(),
                week: targetWeek,
                day: targetDay,
                slot: targetSlot
            };
            
            lessons.push(newLesson);
            triggerAutoSave();
            renderLessons();
            checkConflicts();
            
            // –í–∏–º–∏–∫–∞—î–º–æ —Ä–µ–∂–∏–º –¥—É–±–ª—é–≤–∞–Ω–Ω—è
            cancelDuplication();
        }
        
        function cancelDuplication() {
            duplicateState = { active: false, sourceLesson: null, targetWeek: 1 };
            document.body.classList.remove('mode-duplicate');
            
            // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('duplicate-available', 'duplicate-conflict');
                slot.onclick = null;
            });
        }
        
        function showNotification(message) {
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
                animation: slideIn 0.3s ease;
            `;
            notif.textContent = message;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }
        
        function closeModal() { document.getElementById('addModal').classList.remove('open'); }
        function clearForm() { 
            ['inputGroup','inputSubject','inputTeacher','inputTeacher2','inputNote','inputRoomNumber'].forEach(id=>document.getElementById(id).value=''); 
            const roomSelect = document.getElementById('inputRoomSelect');
            roomSelect.selectedIndex = 0; // –í–∏–±–∏—Ä–∞—î–º–æ –ø–µ—Ä—à—É –æ–ø—Ü—ñ—é "–û–±–µ—Ä—ñ—Ç—å..."
            document.getElementById('inputType').value='–õ–µ–∫—Ü—ñ—è'; 
            toggleCustomRoom(); 
            toggleTeacher2(); 
        }
        function toggleCustomRoom() { document.getElementById('customRoomGroup').style.display = document.getElementById('inputRoomSelect').value === 'auditorium' ? 'block' : 'none'; }
        function toggleTeacher2() { document.getElementById('teacher2Group').style.display = document.getElementById('inputType').value === '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞' ? 'block' : 'none'; }
        
        // --- –°–¢–ê–¢–ò–°–¢–ò–ö–ê ---
        let currentStatsTab = 'general';
        
        function switchStatsTab(tab) {
            currentStatsTab = tab;
            document.querySelectorAll('.stats-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderStats();
        }
        
        function openStats() { 
            document.getElementById('statsWeekNum').innerText = currentWeek === 1 ? 'I' : 'II';
            currentStatsTab = 'general';
            document.querySelectorAll('.stats-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.stats-tab').classList.add('active');
            renderStats();
            document.getElementById('statsModal').classList.add('open');
        }
        
        function renderStats() {
            const c = document.getElementById('statsContent');
            const active = lessons.filter(l => parseInt(l.week) === parseInt(currentWeek));
            
            if(!active.length) {
                c.innerHTML = '<div style="text-align:center;color:gray;padding:2rem;">–ù–µ–º–∞—î –ø–∞—Ä –Ω–∞ —Ü—å–æ–º—É —Ç–∏–∂–Ω—ñ</div>';
                return;
            }
            
            if(currentStatsTab === 'general') {
                c.innerHTML = generateGeneralStats(active);
            } else if(currentStatsTab === 'teachers') {
                c.innerHTML = generateTeachersStats(active);
            } else if(currentStatsTab === 'rooms') {
                c.innerHTML = generateRoomsStats(active);
            }
        }
        
        function generateGeneralStats(active) {
            const allLessons = lessons; // –î–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —Ç–∏–∂–Ω—ñ–≤
            const week1 = allLessons.filter(l => parseInt(l.week) === 1);
            const week2 = allLessons.filter(l => parseInt(l.week) === 2);
            
            // –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const totalHours = active.length * 1.5; // –ö–æ–∂–Ω–∞ –ø–∞—Ä–∞ = 1.5 –≥–æ–¥
            const uniqueGroups = [...new Set(active.map(l => l.group))].filter(g => g);
            const uniqueTeachers = [...new Set(active.flatMap(l => [l.teacher, l.teacher2].filter(t => t)))];
            
            // –†–æ–∑–ø–æ–¥—ñ–ª –ø–æ –¥–Ω—è—Ö
            const dc = {1:0,2:0,3:0,4:0,5:0};
            active.forEach(l => dc[l.day]++);
            const maxD = Math.max(...Object.values(dc)) || 1;
            
            // –ü–æ—Ä–æ–∂–Ω—ñ —Å–ª–æ—Ç–∏
            const emptySlots = {};
            [1,2,3,4,5].forEach(day => {
                emptySlots[day] = [];
                [1,2,3,4,5].forEach(slot => {
                    if(!active.some(l => l.day === day && l.slot === slot)) {
                        emptySlots[day].push(slot);
                    }
                });
            });
            
            // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ—Å—Ç—å –≥—Ä—É–ø
            const groupLoads = {};
            active.forEach(l => {
                if(l.group) {
                    groupLoads[l.group] = (groupLoads[l.group] || 0) + 1;
                }
            });
            const sortedGroups = Object.entries(groupLoads).sort((a,b) => b[1] - a[1]);
            const maxGroupLoad = sortedGroups.length > 0 ? sortedGroups[0][1] : 1;
            
            let html = `
                <!-- –®–≤–∏–¥–∫—ñ –∫–∞—Ä—Ç–∫–∏ -->
                <div class="stat-cards">
                    <div class="stat-card">
                        <div class="stat-card-value">${active.length}</div>
                        <div class="stat-card-label">–í—Å—å–æ–≥–æ –ø–∞—Ä</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value">${totalHours.toFixed(1)}</div>
                        <div class="stat-card-label">–ì–æ–¥–∏–Ω</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value">${uniqueGroups.length}</div>
                        <div class="stat-card-label">–ì—Ä—É–ø</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value">${uniqueTeachers.length}</div>
                        <div class="stat-card-label">–í–∏–∫–ª–∞–¥–∞—á—ñ–≤</div>
                    </div>
                </div>
                
                <!-- –†–æ–∑–ø–æ–¥—ñ–ª –ø–æ –¥–Ω—è—Ö -->
                <div class="stat-section">
                    <div class="stat-title">üìä –†–æ–∑–ø–æ–¥—ñ–ª –ø–æ –¥–Ω—è—Ö —Ç–∏–∂–Ω—è</div>
                    ${['–ü–æ–Ω–µ–¥—ñ–ª–æ–∫','–í—ñ–≤—Ç–æ—Ä–æ–∫','–°–µ—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä',"–ü'—è—Ç–Ω–∏—Ü—è"].map((d,i) => `
                        <div class="stat-row">
                            <div class="stat-label">${d}</div>
                            <div class="stat-bar-container">
                                <div class="stat-bar bar-blue" style="width:${(dc[i+1]/maxD)*100}%"></div>
                            </div>
                            <div class="stat-value">${dc[i+1]}</div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —Ç–∏–∂–Ω—ñ–≤ -->
                <div class="stat-section">
                    <div class="stat-title">‚öñÔ∏è –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —Ç–∏–∂–Ω—ñ–≤</div>
                    <div class="stat-row">
                        <div class="stat-label">–¢–∏–∂–¥–µ–Ω—å I</div>
                        <div class="stat-bar-container">
                            <div class="stat-bar bar-green" style="width:${week1.length > 0 ? (week1.length/Math.max(week1.length, week2.length)*100) : 0}%"></div>
                        </div>
                        <div class="stat-value">${week1.length}</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-label">–¢–∏–∂–¥–µ–Ω—å II</div>
                        <div class="stat-bar-container">
                            <div class="stat-bar bar-purple" style="width:${week2.length > 0 ? (week2.length/Math.max(week1.length, week2.length)*100) : 0}%"></div>
                        </div>
                        <div class="stat-value">${week2.length}</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-label" style="color:#64748b;">–†—ñ–∑–Ω–∏—Ü—è</div>
                        <div class="stat-bar-container"></div>
                        <div class="stat-value" style="color:${week1.length === week2.length ? '#10b981' : '#f59e0b'};">
                            ${Math.abs(week1.length - week2.length)}
                        </div>
                    </div>
                </div>
                
                <!-- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ—Å—Ç—å –≥—Ä—É–ø -->
                ${sortedGroups.length > 0 ? `
                <div class="stat-section">
                    <div class="stat-title">üë• –¢–æ–ø-5 –Ω–∞–π–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ—à–∏—Ö –≥—Ä—É–ø</div>
                    ${sortedGroups.slice(0, 5).map(([group, count]) => `
                        <div class="stat-row">
                            <div class="stat-label">${group}</div>
                            <div class="stat-bar-container">
                                <div class="stat-bar bar-orange" style="width:${(count/maxGroupLoad)*100}%"></div>
                            </div>
                            <div class="stat-value">${count}</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
                
                <!-- –ü–æ—Ä–æ–∂–Ω—ñ —Å–ª–æ—Ç–∏ -->
                <div class="stat-section">
                    <div class="stat-title">‚¨ú –í—ñ–ª—å–Ω—ñ —Å–ª–æ—Ç–∏ (–º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ø–∞—Ä–∏)</div>
                    <div class="empty-slots">
                        ${['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç'].map((day, i) => `
                            <div class="empty-slot-day">
                                <div class="empty-slot-day-name">${day}</div>
                                <div class="empty-slot-list">
                                    ${emptySlots[i+1].length === 0 ? 
                                        '<div class="empty-slot-item" style="border-style:solid;color:#10b981;border-color:#86efac;">–ó–∞–ø–æ–≤–Ω–µ–Ω–æ</div>' : 
                                        emptySlots[i+1].map(slot => `<div class="empty-slot-item">${slot} –ø–∞—Ä–∞</div>`).join('')
                                    }
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function generateTeachersStats(active) {
            // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ—Å—Ç—å –ø–æ –≤–∏–∫–ª–∞–¥–∞—á–∞—Ö
            const teacherLoads = {};
            const teacherDays = {};
            const teacherGroups = {};
            
            active.forEach(l => {
                [l.teacher, l.teacher2].filter(t => t).forEach(teacher => {
                    teacherLoads[teacher] = (teacherLoads[teacher] || 0) + 1;
                    
                    if(!teacherDays[teacher]) teacherDays[teacher] = {1:0,2:0,3:0,4:0,5:0};
                    teacherDays[teacher][l.day]++;
                    
                    if(!teacherGroups[teacher]) teacherGroups[teacher] = new Set();
                    if(l.group) teacherGroups[teacher].add(l.group);
                });
            });
            
            const sortedTeachers = Object.entries(teacherLoads).sort((a,b) => b[1] - a[1]);
            const maxLoad = sortedTeachers.length > 0 ? sortedTeachers[0][1] : 1;
            
            let html = `
                <!-- –¢–æ–ø –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤ -->
                <div class="stat-section">
                    <div class="stat-title">üë®‚Äçüè´ –ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤</div>
                    ${sortedTeachers.map(([teacher, count]) => `
                        <div class="stat-row">
                            <div class="stat-label" title="${teacher}">${teacher}</div>
                            <div class="stat-bar-container">
                                <div class="stat-bar bar-blue" style="width:${(count/maxLoad)*100}%"></div>
                            </div>
                            <div class="stat-value">${count}</div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- –î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø–æ –≤–∏–∫–ª–∞–¥–∞—á–∞—Ö -->
                ${sortedTeachers.slice(0, 10).map(([teacher, count]) => {
                    const days = teacherDays[teacher];
                    const groups = Array.from(teacherGroups[teacher] || []);
                    const maxDayLoad = Math.max(...Object.values(days));
                    
                    return `
                    <div class="stat-section">
                        <div class="stat-title" style="display:flex;justify-content:space-between;align-items:center;">
                            <span>üìå ${teacher} (${count} –ø–∞—Ä, ${(count * 1.5).toFixed(1)} –≥–æ–¥)</span>
                            <button class="btn-sync" style="font-size:0.75rem;padding:4px 10px;" onclick="exportTeacherSchedule('${teacher}')">
                                <i class="fa-solid fa-file-pdf"></i> PDF
                            </button>
                        </div>
                        
                        <!-- –†–æ–∑–ø–æ–¥—ñ–ª –ø–æ –¥–Ω—è—Ö -->
                        <div style="margin-bottom:1rem;">
                            <div style="font-size:0.8rem;color:#64748b;margin-bottom:0.5rem;font-weight:600;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ—Å—Ç—å –ø–æ –¥–Ω—è—Ö:</div>
                            ${['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç'].map((d,i) => `
                                <div class="stat-row">
                                    <div class="stat-label">${d}</div>
                                    <div class="stat-bar-container">
                                        <div class="stat-bar bar-green" style="width:${days[i+1] > 0 ? (days[i+1]/maxDayLoad)*100 : 0}%"></div>
                                    </div>
                                    <div class="stat-value">${days[i+1]}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- –ì—Ä—É–ø–∏ -->
                        ${groups.length > 0 ? `
                        <div>
                            <div style="font-size:0.8rem;color:#64748b;margin-bottom:0.5rem;font-weight:600;">–ì—Ä—É–ø–∏ –≤ —Ä–æ–±–æ—Ç—ñ (${groups.length}):</div>
                            <div style="display:flex;flex-wrap:wrap;gap:6px;">
                                ${groups.map(g => `<span style="background:#e0f2fe;color:#0369a1;padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">${g}</span>`).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    `;
                }).join('')}
            `;
            
            return html;
        }
        
        function generateRoomsStats(active) {
            // –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∞—É–¥–∏—Ç–æ—Ä—ñ–π
            const roomUsage = {};
            const roomTimeSlots = {};
            const roomConflicts = [];
            
            active.forEach(l => {
                if(l.room) {
                    roomUsage[l.room] = (roomUsage[l.room] || 0) + 1;
                    
                    const key = `${l.room}_${l.day}_${l.slot}`;
                    if(!roomTimeSlots[key]) {
                        roomTimeSlots[key] = [];
                    }
                    roomTimeSlots[key].push(l);
                }
            });
            
            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ (–æ–¥–Ω–∞ –∞—É–¥–∏—Ç–æ—Ä—ñ—è –≤ –æ–¥–∏–Ω —á–∞—Å –¥–ª—è –∫—ñ–ª—å–∫–æ—Ö –≥—Ä—É–ø)
            Object.entries(roomTimeSlots).forEach(([key, lessonsInSlot]) => {
                if(lessonsInSlot.length > 1) {
                    const [room, day, slot] = key.split('_');
                    roomConflicts.push({
                        room,
                        day: parseInt(day),
                        slot: parseInt(slot),
                        lessons: lessonsInSlot
                    });
                }
            });
            
            const sortedRooms = Object.entries(roomUsage).sort((a,b) => b[1] - a[1]);
            const maxRoomUsage = sortedRooms.length > 0 ? sortedRooms[0][1] : 1;
            
            // –ü—ñ–∫–æ–≤—ñ –≥–æ–¥–∏–Ω–∏ (–Ω–∞–π–±—ñ–ª—å—à–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ —Å–ª–æ—Ç–∏)
            const slotLoads = {};
            active.forEach(l => {
                if(l.room) {
                    const key = `${l.day}_${l.slot}`;
                    slotLoads[key] = (slotLoads[key] || 0) + 1;
                }
            });
            const sortedSlots = Object.entries(slotLoads).sort((a,b) => b[1] - a[1]);
            
            // –í—ñ–ª—å–Ω—ñ –∞—É–¥–∏—Ç–æ—Ä—ñ—ó –ø–æ —á–∞—Å–∞–º
            const allRooms = [...new Set(active.map(l => l.room).filter(r => r))];
            const freeRoomsBySlot = {};
            
            [1,2,3,4,5].forEach(day => {
                [1,2,3,4,5].forEach(slot => {
                    const key = `${day}_${slot}`;
                    const usedRooms = active.filter(l => l.day === day && l.slot === slot && l.room).map(l => l.room);
                    const freeRooms = allRooms.filter(r => !usedRooms.includes(r));
                    if(freeRooms.length > 0) {
                        freeRoomsBySlot[key] = freeRooms;
                    }
                });
            });
            
            let html = `
                <!-- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∞—É–¥–∏—Ç–æ—Ä—ñ–π -->
                <div class="stat-section">
                    <div class="stat-title">üè¢ –¢–æ–ø –Ω–∞–π–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ—à–∏—Ö –∞—É–¥–∏—Ç–æ—Ä—ñ–π</div>
                    ${sortedRooms.slice(0, 10).map(([room, count]) => `
                        <div class="stat-row">
                            <div class="stat-label">${room}</div>
                            <div class="stat-bar-container">
                                <div class="stat-bar bar-blue" style="width:${(count/maxRoomUsage)*100}%"></div>
                            </div>
                            <div class="stat-value">${count}</div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- –ö–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –∞—É–¥–∏—Ç–æ—Ä—ñ–π -->
                ${roomConflicts.length > 0 ? `
                <div class="stat-section">
                    <div class="stat-title">‚ö†Ô∏è –ö–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –∞—É–¥–∏—Ç–æ—Ä—ñ–π (${roomConflicts.length})</div>
                    ${roomConflicts.map(conflict => {
                        const dayName = ['','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç'][conflict.day];
                        const timeSlot = TIME_SLOTS[conflict.day][conflict.slot - 1];
                        return `
                        <div class="conflict-item">
                            <div class="conflict-header">
                                üö® ${conflict.room} ‚Äî ${dayName}, ${conflict.slot} –ø–∞—Ä–∞ (${timeSlot.time})
                            </div>
                            <div class="conflict-details">
                                ${conflict.lessons.map(l => `‚Ä¢ ${l.group || '–ë–µ–∑ –≥—Ä—É–ø–∏'}: ${l.subject} (${l.teacher})`).join('<br>')}
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
                ` : `
                <div class="stat-section">
                    <div class="stat-title">‚úÖ –ö–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –∞—É–¥–∏—Ç–æ—Ä—ñ–π</div>
                    <div style="text-align:center;padding:1rem;color:#059669;background:#d1fae5;border-radius:8px;font-weight:600;">
                        –ö–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ
                    </div>
                </div>
                `}
                
                <!-- –ü—ñ–∫–æ–≤—ñ –≥–æ–¥–∏–Ω–∏ -->
                <div class="stat-section">
                    <div class="stat-title">üìà –ü—ñ–∫–æ–≤—ñ –≥–æ–¥–∏–Ω–∏ (–Ω–∞–π–±—ñ–ª—å—à–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ)</div>
                    <div class="stat-list">
                        ${sortedSlots.slice(0, 5).map(([key, count]) => {
                            const [day, slot] = key.split('_');
                            const dayName = ['','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç'][parseInt(day)];
                            const timeSlot = TIME_SLOTS[parseInt(day)][parseInt(slot) - 1];
                            return `
                            <div class="stat-list-item">
                                <div class="stat-list-icon">${slot}</div>
                                <div class="stat-list-text">${dayName}, ${timeSlot.time}</div>
                                <div class="stat-list-value">${count} –∞—É–¥.</div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- –í—ñ–ª—å–Ω—ñ –∞—É–¥–∏—Ç–æ—Ä—ñ—ó -->
                ${Object.keys(freeRoomsBySlot).length > 0 ? `
                <div class="stat-section">
                    <div class="stat-title">üÜì –ü—Ä–∏–∫–ª–∞–¥–∏ –≤—ñ–ª—å–Ω–∏—Ö –∞—É–¥–∏—Ç–æ—Ä—ñ–π</div>
                    <div class="stat-list">
                        ${Object.entries(freeRoomsBySlot).slice(0, 8).map(([key, rooms]) => {
                            const [day, slot] = key.split('_');
                            const dayName = ['','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç'][parseInt(day)];
                            const timeSlot = TIME_SLOTS[parseInt(day)][parseInt(slot) - 1];
                            return `
                            <div class="stat-list-item">
                                <div class="stat-list-icon">${slot}</div>
                                <div class="stat-list-text">${dayName}, ${timeSlot.time}</div>
                                <div class="stat-list-value" style="font-size:0.7rem;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${rooms.join(', ')}">${rooms.slice(0,3).join(', ')}${rooms.length > 3 ? '...' : ''}</div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                ` : ''}
            `;
            
            return html;
        }
        
        function closeStats() { document.getElementById('statsModal').classList.remove('open'); }
        
        function openHelp() {
            document.getElementById('helpModal').classList.add('open');
        }
        
        function closeHelp() {
            document.getElementById('helpModal').classList.remove('open');
        }
        document.addEventListener('keydown', e => { 
            if(e.key==='Escape') { 
                if(duplicateState.active) cancelDuplication(); 
                else if(actionState.active) cancelAction(); 
                else if(highlightState.active) clearHighlight(); 
                else closeModal(); 
                closeStats(); 
            } 
        });

        // --- –õ–û–ì–Ü–ö–ê –ü–ï–†–°–û–ù–ê–õ–¨–ù–ò–• –ü–û–°–ò–õ–ê–ù–¨ ---
        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const teacherName = params.get('teacher');
            const groupName = params.get('group');

            // –ü—ñ–¥—Å–≤—ñ—á—É—î–º–æ —ñ –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö, —ñ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø—ñ
            setTimeout(() => {
                if (teacherName) {
                    activateHighlight('teacher', teacherName, { stopPropagation: ()=>{} });
                } else if (groupName) {
                    activateHighlight('group', groupName, { stopPropagation: ()=>{} });
                }
            }, 500);
        }

        function openLinksModal() {
            const container = document.getElementById('linksListContent');
            container.innerHTML = '';
            
            if (!teachersList || teachersList.length === 0) {
                container.innerHTML = '<div>–°–ø–∏—Å–æ–∫ –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π. –°–ø–æ—á–∞—Ç–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –¥–∞–Ω—ñ.</div>';
            } else {
                const baseUrl = window.location.href.split('?')[0];
                
                teachersList.forEach(name => {
                    const link = `${baseUrl}?teacher=${encodeURIComponent(name)}`;
                    
                    const row = document.createElement('div');
                    row.style.cssText = "display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #eee;";
                    
                    row.innerHTML = `
                        <span style="font-weight:600;">${name}</span>
                        <div style="display:flex;gap:6px;">
                            <button class="btn-sync" style="font-size:0.8rem;" onclick="exportTeacherSchedule('${name}')">
                                <i class="fa-solid fa-file-pdf"></i> PDF
                            </button>
                            <button class="btn-sync" style="font-size:0.8rem;" onclick="copyLink('${link}')">
                                <i class="fa-regular fa-copy"></i> –ü–æ—Å–∏–ª–∞–Ω–Ω—è
                            </button>
                        </div>
                    `;
                    container.appendChild(row);
                });
            }
            
            document.getElementById('linksModal').classList.add('open');
        }

        function copyLink(text) {
            navigator.clipboard.writeText(text).then(() => {
                customAlert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!', '–£—Å–ø—ñ—à–Ω–æ', 'success');
            });
        }


        // --- –†–û–ó–®–ò–†–ï–ù–ò–ô –ü–û–®–£–ö ---
        let advancedSearchFilters = {};
        let advancedSearchFiltersOriginal = {};
        
        function toggleAdvancedSearch() {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –∞–∫—Ç–∏–≤–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
            const hasActiveFilters = Object.keys(advancedSearchFilters).length > 0 && 
                                     Object.values(advancedSearchFilters).some(v => v !== '');
            
            if (hasActiveFilters) {
                // –Ø–∫—â–æ —Ñ—ñ–ª—å—Ç—Ä–∏ –∞–∫—Ç–∏–≤–Ω—ñ - —Å–∫–∏–¥–∞—î–º–æ —ó—Ö
                resetAdvancedSearch();
                updateFilterButtonState(false);
            } else {
                // –Ø–∫—â–æ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ –Ω–µ–º–∞—î - –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
                openAdvancedSearch();
            }
        }
        
        function openAdvancedSearch() {
            document.getElementById('advancedSearchModal').classList.add('open');
        }
        
        function closeAdvancedSearch() {
            document.getElementById('advancedSearchModal').classList.remove('open');
        }
        
        function resetAdvancedSearch() {
            document.getElementById('advSearchTeacher').value = '';
            document.getElementById('advSearchGroup').value = '';
            document.getElementById('advSearchSubject').value = '';
            document.getElementById('advSearchType').value = '';
            document.getElementById('advSearchRoom').value = '';
            document.getElementById('advSearchDay').value = '';
            advancedSearchFilters = {};
            advancedSearchFiltersOriginal = {};
            
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –ø–∞–Ω–µ–ª—å —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
            const panel = document.getElementById('filter-panel');
            if (panel) panel.classList.remove('show');
            
            renderLessons();
        }
        
        function updateFilterButtonState(isActive) {
            const btnAdmin = document.getElementById('filterBtnAdmin');
            
            if (isActive) {
                // –ê–∫—Ç–∏–≤–Ω–∏–π —Å—Ç–∞–Ω - –∂–æ–≤—Ç–∞ –∫–Ω–æ–ø–∫–∞ –∑ —ñ–Ω—à–æ—é —ñ–∫–æ–Ω–∫–æ—é
                if (btnAdmin) {
                    btnAdmin.classList.add('btn-filter-active');
                    btnAdmin.innerHTML = '<i class="fa-solid fa-filter-circle-xmark"></i> –°–∫–∏–Ω—É—Ç–∏';
                    btnAdmin.title = '–°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏';
                }
            } else {
                // –ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π —Å—Ç–∞–Ω - –∑–≤–∏—á–∞–π–Ω–∞ –∫–Ω–æ–ø–∫–∞
                if (btnAdmin) {
                    btnAdmin.classList.remove('btn-filter-active');
                    btnAdmin.innerHTML = '<i class="fa-solid fa-filter"></i> –§—ñ–ª—å—Ç—Ä–∏';
                    btnAdmin.title = '–ü–æ—à—É–∫ —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä–∏';
                }
            }
        }
        
        function applyAdvancedSearch() {
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
            const originalValues = {
                teacher: document.getElementById('advSearchTeacher').value.trim(),
                group: document.getElementById('advSearchGroup').value.trim(),
                subject: document.getElementById('advSearchSubject').value.trim(),
                type: document.getElementById('advSearchType').value,
                room: document.getElementById('advSearchRoom').value.trim(),
                day: document.getElementById('advSearchDay').value
            };
            
            console.log('[FILTER DEBUG] originalValues:', originalValues);
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ –∑ toLowerCase –¥–ª—è –ø–æ—à—É–∫—É
            const filters = {
                teacher: originalValues.teacher.toLowerCase(),
                group: originalValues.group.toLowerCase(),
                subject: originalValues.subject.toLowerCase(),
                type: originalValues.type,
                room: originalValues.room.toLowerCase(),
                day: originalValues.day
            };
            
            console.log('[FILTER DEBUG] filters:', filters);
            console.log('[FILTER DEBUG] Object.values(filters):', Object.values(filters));
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ö–æ—á –æ–¥–∏–Ω —Ñ—ñ–ª—å—Ç—Ä –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–π
            const hasFilters = Object.values(filters).some(v => v !== '');
            
            console.log('[FILTER DEBUG] hasFilters:', hasFilters);
            
            if (!hasFilters) {
                customAlert('–û–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –ø–æ—à—É–∫—É!');
                return;
            }
            
            advancedSearchFilters = filters;
            advancedSearchFiltersOriginal = originalValues;
            
            console.log('[FILTER DEBUG] Filters applied, closing modal');
            
            // –û—á–∏—â–∞—î–º–æ highlight, —è–∫—â–æ –≤—ñ–Ω –±—É–≤ –∞–∫—Ç–∏–≤–Ω–∏–π
            if (highlightState.active) {
                highlightState.active = false;
                document.body.classList.remove('spotlight-active');
                document.querySelectorAll('.lesson-card').forEach(c => c.classList.remove('highlighted'));
            }
            
            renderLessons();
            closeAdvancedSearch();
            
            console.log('[FILTER DEBUG] Updating button state');
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –∫–Ω–æ–ø–∫–∏
            updateFilterButtonState(true);
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –ø–∞–Ω–µ–ª—å –∑ –∞–∫—Ç–∏–≤–Ω–∏–º–∏ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏
            showFilterPanel();
        }
        
        function showFilterPanel() {
            const panel = document.getElementById('filter-panel');
            if (!panel) return;
            
            // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
            const displayFilters = advancedSearchFiltersOriginal || advancedSearchFilters;
            
            const activeFilters = [];
            if (displayFilters.teacher) activeFilters.push(`–í–∏–∫–ª–∞–¥–∞—á: ${displayFilters.teacher}`);
            if (displayFilters.group) activeFilters.push(`–ì—Ä—É–ø–∞: ${displayFilters.group}`);
            if (displayFilters.subject) activeFilters.push(`–ü—Ä–µ–¥–º–µ—Ç: ${displayFilters.subject}`);
            if (displayFilters.type) activeFilters.push(`–¢–∏–ø: ${displayFilters.type}`);
            if (displayFilters.room) activeFilters.push(`–ê—É–¥–∏—Ç–æ—Ä—ñ—è: ${displayFilters.room}`);
            if (displayFilters.day) {
                const days = ['', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç'];
                activeFilters.push(`–î–µ–Ω—å: ${days[displayFilters.day]}`);
            }
            
            panel.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                    <i class="fa-solid fa-filter"></i>
                    <strong>–ê–∫—Ç–∏–≤–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏:</strong>
                    ${activeFilters.join(' ‚Ä¢ ')}
                    <button class="btn-sync" style="margin-left:auto;" onclick="resetAdvancedSearch(); updateFilterButtonState(false);">
                        <i class="fa-solid fa-xmark"></i> –°–∫–∏–Ω—É—Ç–∏
                    </button>
                </div>
            `;
            panel.classList.add('show');
        }
        
        function matchesAdvancedFilters(lesson) {
            if (Object.keys(advancedSearchFilters).length === 0) return true;
            
            const filters = advancedSearchFilters;
            
            if (filters.teacher) {
                const teacherMatch = (lesson.teacher && typeof lesson.teacher === 'string' && lesson.teacher.toLowerCase().includes(filters.teacher)) ||
                                   (lesson.teacher2 && typeof lesson.teacher2 === 'string' && lesson.teacher2.toLowerCase().includes(filters.teacher));
                if (!teacherMatch) return false;
            }
            
            if (filters.group && (!lesson.group || typeof lesson.group !== 'string' || !lesson.group.toLowerCase().includes(filters.group))) {
                return false;
            }
            
            if (filters.subject && (!lesson.subject || typeof lesson.subject !== 'string' || !lesson.subject.toLowerCase().includes(filters.subject))) {
                return false;
            }
            
            if (filters.type && lesson.type !== filters.type) {
                return false;
            }
            
            if (filters.room && (!lesson.room || typeof lesson.room !== 'string' || !lesson.room.toLowerCase().includes(filters.room))) {
                return false;
            }
            
            if (filters.day && lesson.day !== parseInt(filters.day)) {
                return false;
            }
            
            return true;
        }

        // --- –ï–ö–°–ü–û–†–¢ PDF –î–õ–Ø –í–ò–ö–õ–ê–î–ê–ß–Ü–í ---
        function exportTeacherSchedule(teacherName) {
            if (!teacherName) {
                teacherName = prompt('–í–≤–µ–¥—ñ—Ç—å –ø—Ä—ñ–∑–≤–∏—â–µ –≤–∏–∫–ª–∞–¥–∞—á–∞:');
                if (!teacherName) return;
            }
            
            // –ó–±–∏—Ä–∞—î–º–æ –≤—Å—ñ –ø–∞—Ä–∏ –≤–∏–∫–ª–∞–¥–∞—á–∞
            const teacherLessons = lessons.filter(l => 
                l.teacher === teacherName || l.teacher2 === teacherName
            ).sort((a, b) => {
                if (a.week !== b.week) return a.week - b.week;
                if (a.day !== b.day) return a.day - b.day;
                return a.slot - b.slot;
            });
            
            if (teacherLessons.length === 0) {
                customAlert('–ü–∞—Ä –¥–ª—è —Ü—å–æ–≥–æ –≤–∏–∫–ª–∞–¥–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
                return;
            }
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ HTML –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É
            const html = generateTeacherScheduleHTML(teacherName, teacherLessons);
            
            // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ —É –Ω–æ–≤–æ–º—É –≤—ñ–∫–Ω—ñ
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
        }
        
        function generateTeacherScheduleHTML(teacherName, teacherLessons) {
            const week1 = teacherLessons.filter(l => l.week === 1);
            const week2 = teacherLessons.filter(l => l.week === 2);
            
            const dayNames = ['', '–ü–æ–Ω–µ–¥—ñ–ª–æ–∫', '–í—ñ–≤—Ç–æ—Ä–æ–∫', '–°–µ—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä', "–ü'—è—Ç–Ω–∏—Ü—è"];
            
            const generateWeekTable = (lessons, weekNum) => {
                const grouped = {};
                lessons.forEach(l => {
                    const key = `${l.day}-${l.slot}`;
                    if (!grouped[key]) grouped[key] = [];
                    grouped[key].push(l);
                });
                
                let rows = '';
                [1,2,3,4,5].forEach(day => {
                    [1,2,3,4,5].forEach(slot => {
                        const key = `${day}-${slot}`;
                        const lessonsInSlot = grouped[key] || [];
                        const timeSlot = TIME_SLOTS[day][slot - 1];
                        
                        if (lessonsInSlot.length > 0) {
                            lessonsInSlot.forEach(lesson => {
                                rows += `
                                    <tr>
                                        <td>${dayNames[day]}</td>
                                        <td style="text-align:center;">${slot}</td>
                                        <td style="text-align:center;">${timeSlot.time}</td>
                                        <td><strong>${lesson.subject}</strong></td>
                                        <td style="text-align:center;">${lesson.type}</td>
                                        <td style="text-align:center;">${lesson.group || '-'}</td>
                                        <td style="text-align:center;">${lesson.room || '-'}</td>
                                    </tr>
                                `;
                            });
                        }
                    });
                });
                
                return rows || '<tr><td colspan="7" style="text-align:center;color:#999;padding:30px;">–ù–µ–º–∞—î –ø–∞—Ä –Ω–∞ —Ü—å–æ–º—É —Ç–∏–∂–Ω—ñ</td></tr>';
            };
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>–†–æ–∑–∫–ª–∞–¥ - ${teacherName}</title>
                    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
                    <style>
                        @page {
                            margin: 2cm 1.5cm;
                        }
                        
                        body { 
                            font-family: 'Segoe UI', 'Arial', sans-serif; 
                            margin: 0;
                            padding: 0;
                            font-size: 11pt;
                            line-height: 1.4;
                        }
                        
                        /* –í–µ—Ä—Ö–Ω—ñ–π –∫–æ–ª–æ–Ω—Ç–∏—Ç—É–ª */
                        .page-header {
                            border-bottom: 2px solid #b8956a;
                            padding-bottom: 12px;
                            margin-bottom: 25px;
                        }
                        
                        .header-title {
                            font-size: 18pt;
                            font-weight: 700;
                            color: #2d2416;
                            margin: 0 0 8px 0;
                        }
                        
                        .header-info {
                            display: grid;
                            grid-template-columns: auto 1fr;
                            gap: 8px;
                            font-size: 10pt;
                            color: #5c4d3d;
                        }
                        
                        .header-label {
                            font-weight: 600;
                            color: #3d3020;
                        }
                        
                        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∏–∂–Ω—è */
                        .week-title {
                            font-size: 14pt;
                            font-weight: 700;
                            color: #8b6914;
                            margin: 0 0 15px 0;
                            padding: 8px 12px;
                            background: linear-gradient(135deg, #fef3c7 0%, #fef9e7 100%);
                            border-left: 4px solid #d4a574;
                            border-radius: 4px;
                        }
                        
                        /* –¢–∞–±–ª–∏—Ü—è */
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-bottom: 20px;
                            font-size: 10pt;
                        }
                        
                        /* –¢–µ–ø–ª–∞ –ø–∞—Å—Ç–µ–ª—å–Ω–∞ —à–∞–ø–∫–∞ —Ç–∞–±–ª–∏—Ü—ñ */
                        th { 
                            background: linear-gradient(180deg, #e8d5b7 0%, #d4bf9f 100%);
                            color: #3d3020; 
                            padding: 10px 8px;
                            text-align: left;
                            font-weight: 700;
                            border: 2px solid #b8956a;
                            font-size: 9.5pt;
                        }
                        
                        td { 
                            padding: 8px;
                            border: 1px solid #d4bf9f;
                            vertical-align: top;
                        }
                        
                        tr:nth-child(even) { 
                            background: #faf8f3; 
                        }
                        
                        tr:hover {
                            background: #fef3c7;
                        }
                        
                        /* –ü—ñ–¥—Å—É–º–∫–∏ */
                        .summary {
                            margin-top: 15px;
                            padding: 12px 15px;
                            background: #fef9e7;
                            border-radius: 6px;
                            border-left: 4px solid #b8956a;
                            font-size: 10pt;
                            color: #5c4d3d;
                            display: flex;
                            gap: 20px;
                            align-items: center;
                        }
                        
                        .summary-item {
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        }
                        
                        .summary-value {
                            font-weight: 700;
                            color: #3d3020;
                            font-size: 12pt;
                        }
                        
                        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
                        .action-buttons {
                            display: flex;
                            gap: 10px;
                            margin-bottom: 20px;
                            flex-wrap: wrap;
                        }
                        
                        /* –ö–Ω–æ–ø–∫–∏ –µ–∫—Å–ø–æ—Ä—Ç—É */
                        .export-btn { 
                            background: white;
                            color:    font-size: 11pt;
                            font-weight: 600;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        }
                        
                        .export-btn:hover {
                            background: #b8956a;
                            color: white;
                            transform: translateY(-1px);
                            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
                        }
                        
                        .export-btn i {
                            font-size: 13pt;
                        }
                        
                        /* –î–ª—è –¥—Ä—É–∫—É */
                        @media print {
                            .no-print { 
                                display: none; 
                            }
                            
                            /* –ö–æ–∂–µ–Ω —Ç–∏–∂–¥–µ–Ω—å –Ω–∞ –æ–∫—Ä–µ–º—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ */
                            .page-break {
                                page-break-before: always;
                            }
                            
                            body {
                                font-size: 10pt;
                            }
                            
                            table {
                                page-break-inside: auto;
                            }
                            
                            tr {
                                page-break-inside: avoid;
                                page-break-after: auto;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="action-buttons no-print">
                        <button class="export-btn" onclick="window.print()">
                            <i class="fa-solid fa-print"></i> –î—Ä—É–∫—É–≤–∞—Ç–∏ / –ó–±–µ—Ä–µ–≥—Ç–∏ PDF
                        </button>
                    </div>
                    
                    <!-- –í–µ—Ä—Ö–Ω—ñ–π –∫–æ–ª–æ–Ω—Ç–∏—Ç—É–ª –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é -->
                    <div class="page-header">
                        <div class="header-title">–†–æ–∑–∫–ª–∞–¥ –∑–∞–Ω—è—Ç—å</div>
                        <div class="header-info">
                            <span class="header-label">–í–∏–∫–ª–∞–¥–∞—á:</span>
                            <span>${teacherName}</span>
                            <span class="header-label">–ö–∞—Ñ–µ–¥—Ä–∞:</span>
                            <span>–ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç—É –Ü–¢-—Å—Ñ–µ—Ä–∏</span>
                            <span class="header-label">–î–∞—Ç–∞:</span>
                            <span>${new Date().toLocaleDateString('uk-UA', {year: 'numeric', month: 'long', day: 'numeric'})}</span>
                        </div>
                    </div>
                    
                    <!-- –¢–∏–∂–¥–µ–Ω—å I -->
                    <div class="week-title">–¢–∏–∂–¥–µ–Ω—å I (—á–∏—Å–µ–ª—å–Ω–∏–∫)</div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 12%;">–î–µ–Ω—å</th>
                                <th style="width: 7%; text-align: center;">–ü–∞—Ä–∞</th>
                                <th style="width: 12%; text-align: center;">–ß–∞—Å</th>
                                <th style="width: 30%;">–î–∏—Å—Ü–∏–ø–ª—ñ–Ω–∞</th>
                                <th style="width: 12%; text-align: center;">–¢–∏–ø</th>
                                <th style="width: 12%; text-align: center;">–ì—Ä—É–ø–∞</th>
                                <th style="width: 15%; text-align: center;">–ê—É–¥–∏—Ç–æ—Ä—ñ—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generateWeekTable(week1, 1)}
                        </tbody>
                    </table>
                    
                    <div class="summary">
                        <div class="summary-item">
                            <span>–í—Å—å–æ–≥–æ –ø–∞—Ä:</span>
                            <span class="summary-value">${week1.length}</span>
                        </div>
                    </div>
                    
                    <!-- –¢–∏–∂–¥–µ–Ω—å II –Ω–∞ –Ω–æ–≤—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ -->
                    <div class="page-break"></div>
                    
                    <!-- –ü–æ–≤—Ç–æ—Ä—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –¥—Ä—É–≥–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ -->
                    <div class="page-header">
                        <div class="header-title">–†–æ–∑–∫–ª–∞–¥ –∑–∞–Ω—è—Ç—å</div>
                        <div class="header-info">
                            <span class="header-label">–í–∏–∫–ª–∞–¥–∞—á:</span>
                            <span>${teacherName}</span>
                            <span class="header-label">–ö–∞—Ñ–µ–¥—Ä–∞:</span>
                            <span>–ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç—É –Ü–¢-—Å—Ñ–µ—Ä–∏</span>
                            <span class="header-label">–î–∞—Ç–∞:</span>
                            <span>${new Date().toLocaleDateString('uk-UA', {year: 'numeric', month: 'long', day: 'numeric'})}</span>
                        </div>
                    </div>
                    
                    <div class="week-title">–¢–∏–∂–¥–µ–Ω—å II (–∑–Ω–∞–º–µ–Ω–Ω–∏–∫)</div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 12%;">–î–µ–Ω—å</th>
                                <th style="width: 7%; text-align: center;">–ü–∞—Ä–∞</th>
                                <th style="width: 12%; text-align: center;">–ß–∞—Å</th>
                                <th style="width: 30%;">–î–∏—Å—Ü–∏–ø–ª—ñ–Ω–∞</th>
                                <th style="width: 12%; text-align: center;">–¢–∏–ø</th>
                                <th style="width: 12%; text-align: center;">–ì—Ä—É–ø–∞</th>
                                <th style="width: 15%; text-align: center;">–ê—É–¥–∏—Ç–æ—Ä—ñ—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generateWeekTable(week2, 2)}
                        </tbody>
                    </table>
                    
                    <div class="summary">
                        <div class="summary-item">
                            <span>–í—Å—å–æ–≥–æ –ø–∞—Ä:</span>
                            <span class="summary-value">${week2.length}</span>
                        </div>
                    </div>
                    
                    <!-- –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–Ω–∏–∑—É –¥—Ä—É–≥–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ -->
                    <div class="summary" style="margin-top: 30px; border-left-color: #d4a574;">
                        <div class="summary-item">
                            <span>–ó–∞–≥–∞–ª–æ–º –∑–∞ –¥–≤–∞ —Ç–∏–∂–Ω—ñ:</span>
                            <span class="summary-value">${teacherLessons.length} –ø–∞—Ä</span>
                        </div>
                    </div>
                </body>
                </html>
            `;
        }
        init();
    </script>
</body>
</html>
